function Aircraft(aircraftString){this._conflicting=false;this._selected=false;this._lastSimulated=0;this._elapsed=0;this._callsign;this._type;this._category;this._flightRules;this._departure;this._arrival;this._cuiseAltitude;this._route;this._remarks;this._squawk;this._squawkMode;this._lat;this._lon;this._altitude;this._speed;this._heading;this._history=[];this._performance=new AircraftPerformance;this._autopilot=new Autopilot(this);this._assignments={};if(typeof aircraftString=="string")this.loadFromString(aircraftString)}Aircraft.prototype.updateElapsed=function(elapsedSituation){this._elapsed=elapsedSituation-this._lastSimulated};Aircraft.prototype.updateAssignments=function(){for(var i in this._assignments)if(this._assignments[i].delay>=0)this._assignments[i].delay=Math.max(0,this._assignments[i].delay-this._elapsed)};Aircraft.prototype.assignmentFunction=function(t,type,rateFunction,updateAssignment){if(this._assignments[type]&&t>=this._assignments[type].delay){var deltaTotal=this._assignments[type].value-this["_"+type];var deltaSign=deltaTotal<0?-1:1;var elapsed=t-this._assignments[type].delay;var delta=deltaSign*rateFunction()*(elapsed/1e3);if(Math.abs(delta)>=Math.abs(deltaTotal)||deltaTotal==0){delta=deltaTotal;if(updateAssignment)delete this._assignments[type]}return this["_"+type]+delta}return this["_"+type]};Aircraft.prototype.altitudeFunction=function(t,updateAssignment){var aircraft=this;return this.assignmentFunction(t,"altitude",function(){return aircraft._performance.climbRate()},updateAssignment)};Aircraft.prototype.speedFunction=function(t,updateAssignment){var aircraft=this;return this.assignmentFunction(t,"speed",function(){return aircraft._performance.accelerationRate()},updateAssignment)};Aircraft.prototype.headingFunction=function(t,updateAssignment){if(this._assignments.heading&&t>=this._assignments.heading.delay){var deltaTotal=(this._assignments.heading.value-this._heading+360)%360;if(Math.abs(deltaTotal-360)<deltaTotal)deltaTotal-=360;var deltaSign=deltaTotal<0?-1:1;var elapsed=t-this._assignments.heading.delay;var delta=deltaSign*this._performance.turnRate()*(elapsed/1e3);if(Math.abs(delta)>=Math.abs(deltaTotal)||deltaTotal==0){delta=deltaTotal;if(updateAssignment)delete this._assignments.heading}return(this._heading+delta)%360}return this._heading};Aircraft.prototype.positionFunction=function(t,updateAssignment){var averageHeading=(this._heading+pastHeading)/2+r.magVar();var averageSpeed=this.groundspeed((this._speed+pastSpeed)/2,(this._altitude+pastAltitude)/2);var distance=averageSpeed*this._elapsed*1.852/36e5;var destination=new LatLon(this._lat,this._lon).destinationPoint(averageHeading,distance);this._lat=destination._lat;this._lon=destination._lon};Aircraft.prototype.trueAirspeedFunction=function(t){return this.altitudeFunction(t)/200+this.speedFunction(t)};Aircraft.prototype.trueGroundspeedFunction=function(t){return this.trueAirspeedFunction(t)};Aircraft.prototype.turnRadius=function(){var gravity=9.80665;var metersInNauticalMile=1852;var metersPerSecondInKnot=.514444;var bankAngle=this._performance.bankAngle(this._altitude)*Math.PI/180;return Math.pow(this.groundspeed()*metersPerSecondInKnot,2)/(gravity*Math.tan(bankAngle))/metersInNauticalMile};Aircraft.prototype.headingDelta=function(turnRadius){var radius=turnRadius||this.turnRadius();return this.groundspeed()/3600*(this._elapsed/1e3)/(radius*2*Math.PI)*360};Aircraft.prototype.fly=function(r,elapsedSituation){this.updateElapsed(elapsedSituation);if(this._elapsed>=5e3){this._lastSimulated=elapsedSituation;if(!this._autopilot.fly(r)){this.updateHistory();this.updatePosition(this.updateHeading(),this.updateSpeed(),this.updateAltitude(),r);this.updateAssignments()}}};Aircraft.prototype.updateHistory=function(){this._history.unshift({lat:this._lat,lon:this._lon});if(this._history.length>5)this._history.pop()};Aircraft.prototype.updatePosition=function(pastHeading,pastSpeed,pastAltitude,r){var averageHeading=(this._heading+pastHeading)/2+r.magVar();var averageSpeed=this.groundspeed((this._speed+pastSpeed)/2,(this._altitude+pastAltitude)/2);var distance=averageSpeed*this._elapsed*1.852/36e5;var destination=new LatLon(this._lat,this._lon).destinationPoint(averageHeading,distance);this._lat=destination._lat;this._lon=destination._lon};Aircraft.prototype.updateHeading=function(){var heading=this._heading;this._heading=this.headingFunction(this._elapsed,true);return heading};Aircraft.prototype.updateSpeed=function(){var speed=this._speed;this._speed=this.speedFunction(this._elapsed,true);return speed};Aircraft.prototype.updateAltitude=function(){var altitude=this._altitude;this._altitude=this.altitudeFunction(this._elapsed,true);return altitude};Aircraft.prototype.updateElapsed=function(elapsedSituation){this._elapsed=elapsedSituation-this._lastSimulated};Aircraft.prototype.assignHeading=function(heading,elapsedSituation,delay){this.assign("heading",heading,elapsedSituation,delay)};Aircraft.prototype.assignSpeed=function(speed,elapsedSituation,delay){this.assign("speed",speed,elapsedSituation,delay)};Aircraft.prototype.assignAltitude=function(altitude,elapsedSituation,delay){this.assign("altitude",altitude,elapsedSituation,delay)};Aircraft.prototype.assign=function(type,value,elapsedSituation,delay){this._assignments[type]={value:value,delay:this.delay(elapsedSituation,delay)}};Aircraft.prototype.delay=function(elapsedSituation,delay){return(delay||0)+elapsedSituation-this._lastSimulated};Aircraft.prototype.loadFromString=function(aircraftString){var segments=aircraftString.split(":");this._callsign=$.trim(segments[0]);this._type=$.trim(segments[1]);this._category=$.trim(segments[2]);this._flightRules=$.trim(segments[3]);this._departure=$.trim(segments[4]);this._arrival=$.trim(segments[5]);this._cuiseAltitude=parseInt($.trim(segments[6]));this._route=$.trim(segments[7]);this._remarks=$.trim(segments[8]);this._squawk=$.trim(segments[9]);this._squawkMode=$.trim(segments[10]);this._lat=parseFloat($.trim(segments[11]));this._lon=parseFloat($.trim(segments[12]));this._altitude=parseInt($.trim(segments[13]));this._speed=parseInt($.trim(segments[14]));this._heading=parseInt($.trim(segments[15]));this._performance.loadFromCategory(this._category)};Aircraft.prototype.update=function(aircraft,aircraftList,elapsedSituation){if(aircraftList[aircraft.callsign()]&&(aircraftList[aircraft.callsign()].lat()!=aircraft.lat()||aircraftList[aircraft.callsign()].lon()!=aircraft.lon())){this._lastSimulated=elapsedSituation;this._lat=aircraft.lat();this._lon=aircraft.lon();this._heading=aircraft.heading();this._altitude=aircraft.altitude();this._speed=aircraft.speed()}};Aircraft.prototype.callsign=function(){return this._callsign};Aircraft.prototype.type=function(){return this._type};Aircraft.prototype.category=function(){return this._category};Aircraft.prototype.flightRules=function(){return this._flightRules};Aircraft.prototype.departure=function(){return this._departure};Aircraft.prototype.arrival=function(){return this._arrival};Aircraft.prototype.cruiseAltitude=function(){return this._cruiseAltitude};Aircraft.prototype.route=function(){return this._route};Aircraft.prototype.remarks=function(){return this._remarks};Aircraft.prototype.squawk=function(){return this._squawk};Aircraft.prototype.squawkMode=function(){return this._squawkMode};Aircraft.prototype.lat=function(){return this._lat};Aircraft.prototype.lon=function(){return this._lon};Aircraft.prototype.position=function(){return new LatLon(this._lat,this._lon)};Aircraft.prototype.altitude=function(){return this._altitude};Aircraft.prototype.speed=function(){return this._speed};Aircraft.prototype.heading=function(){return this._heading};Aircraft.prototype.performance=function(){return this._performance};Aircraft.prototype.setCallsign=function(callsign){this._callsign=callsign};Aircraft.prototype.setType=function(type){this._type=type};Aircraft.prototype.setCategory=function(category){this._category=category};Aircraft.prototype.setFlightRules=function(flightRules){this._flightRules=flightRules};Aircraft.prototype.setDeparture=function(departure){this._departure=departure};Aircraft.prototype.setArrival=function(arrival){this._arrival=arrival};Aircraft.prototype.setCruiseAltitude=function(cruiseAltitude){this._cruiseAltitude=cruiseAltitude};Aircraft.prototype.setRoute=function(route){this._route=route};Aircraft.prototype.setRemarks=function(remarks){this._remarks=remarks};Aircraft.prototype.setSquawk=function(squawk){this._squawk=squawk};Aircraft.prototype.setSquawkMode=function(squawkMode){this._squawkMode=squawkMode};Aircraft.prototype.setLat=function(lat){this._lat=lat};Aircraft.prototype.setLon=function(lon){this._lon=lon};Aircraft.prototype.setAltitude=function(altitude){this._altitude=altitude};Aircraft.prototype.setSpeed=function(speed){this._speed=speed};Aircraft.prototype.setHeading=function(heading){this._heading=heading};Aircraft.prototype.setLastSimulated=function(lastSimulated){this._lastSimulated=lastSimulated};Aircraft.prototype.groundspeed=function(airspeed,altitude){return(altitude?altitude:this._altitude)/200+(airspeed?airspeed:this._speed)};Aircraft.prototype.airspeed=function(groundspeed,altitude){return groundspeed?groundspeed-(altitude?altitude:this._altitude)/200:this._speed};Aircraft.prototype.select=function(){this._selected=true};Aircraft.prototype.deselect=function(){this._selected=false};Aircraft.prototype.setConflicting=function(conflicting){this._conflicting=conflicting};Aircraft.prototype.renderHistory=function(r){if(r.targetHistory()){r.context().fillStyle="#00f";for(var i in this._history){var historyPos=r.gtoc(this._history[i].lat,this._history[i].lon);r.context().beginPath();r.context().arc(historyPos.x,historyPos.y,5-Math.floor(i/2),0,2*Math.PI);r.context().globalAlpha=.5-i/10;r.context().fill()}r.context().globalAlpha=1}};Aircraft.prototype.renderTarget=function(r){var radarDistance=r.radarCenterPosition().distanceTo(this.position())*.539957;var beaconWidth=Math.min(Math.max(4*Math.sqrt(radarDistance),4),32);var acPos=r.gtoc(this._lat,this._lon);var radarCenter=r.radarCenter();var theta=r.angleBetween(acPos.x,acPos.y,radarCenter.x,radarCenter.y)+Math.PI/2;var lineL=r.rotate(-beaconWidth,0,0,0,theta);var lineR=r.rotate(beaconWidth,0,0,0,theta);r.context().beginPath();r.context().moveTo(acPos.x+lineL.x,acPos.y+lineL.y);r.context().lineTo(acPos.x+lineR.x,acPos.y+lineR.y);r.context().strokeStyle="#1e582f";r.context().lineWidth=2;r.context().stroke();var boxBL=r.rotate(-beaconWidth/2,0,0,0,theta);var boxTL=r.rotate(-beaconWidth/2,9,0,0,theta);var boxTR=r.rotate(beaconWidth/2,9,0,0,theta);var boxBR=r.rotate(beaconWidth/2,0,0,0,theta);r.context().beginPath();r.context().moveTo(acPos.x+boxBL.x,acPos.y+boxBL.y);r.context().lineTo(acPos.x+boxTL.x,acPos.y+boxTL.y);r.context().lineTo(acPos.x+boxTR.x,acPos.y+boxTR.y);r.context().lineTo(acPos.x+boxBR.x,acPos.y+boxBR.y);r.context().fillStyle="#2d82ed";r.context().fill()};Aircraft.prototype.renderPosition=function(r){var acPos=r.gtoc(this._lat,this._lon);r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="center";r.context().textBaseline="middle";r.context().strokeStyle="#000";r.context().lineWidth=2;r.context().strokeText("A",acPos.x,acPos.y);r.context().fillStyle="#fff";r.context().fillText("A",acPos.x,acPos.y)};Aircraft.prototype.renderDataBlock=function(r,elapsed){var acPos=r.gtoc(this._lat,this._lon);var renderColor=this._conflicting?"#f00":this._selected?"#ff0":"#fff";r.context().beginPath();r.context().moveTo(acPos.x+10,acPos.y+-10);r.context().lineTo(acPos.x+30,acPos.y+-30);r.context().lineWidth=1;r.context().strokeStyle=renderColor;r.context().stroke();r.context().beginPath();r.context().imageSmoothingEnabled=false;r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="middle";r.context().fillStyle=renderColor;r.context().fillText(this._callsign,acPos.x+35,acPos.y+-35);r.context().imageSmoothingEnabled=true;r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="middle";r.context().fillStyle=renderColor;var scopeSpeed=Math.floor(this.groundspeed()/10);var scopeAltitude=Math.floor(this._altitude/100);r.context().fillText(r.pad(scopeAltitude,3)+"  "+(elapsed%4e3<2e3?r.pad(scopeSpeed,2):this._type),acPos.x+35,acPos.y+-20)};function AircraftPerformance(category){this._climbRate=2e3;this._turnRate=3;this._accelerationRate=1;this._bankAngle=25;this._smoothAltitude=18e3;if(typeof category=="string")this.loadFromCategory(category)}AircraftPerformance.prototype.loadFromCategory=function(category){if(category=="J"){this._climbRate=2e3;this._turnRate=3;this._accelerationRate=1}};AircraftPerformance.prototype.climbRate=function(){return this._climbRate/60};AircraftPerformance.prototype.turnRate=function(){return this._turnRate};AircraftPerformance.prototype.accelerationRate=function(){return this._accelerationRate};AircraftPerformance.prototype.bankAngle=function(alt){var altitude=alt||0;return alt>=this._smoothAltitude?this._bankAngle*.4:this._bankAngle};function Airport(icao,iata,lat,lon,elevation){this._icao=icao;this._iata=iata;this._lat=lat;this._lon=lon;this._elevation=elevation;this._runways={}}Airport.prototype.numRunways=function(){return this._runways.length/2};Airport.prototype.addRunway=function(runway,oppositeRunway){this._runways[runway.id()]=runway;this._runways[oppositeRunway.id()]=oppositeRunway};Airport.prototype.runway=function(id){return this._runways[id]};Airport.prototype.position=function(){return new LatLon(this._lat,this._lon)};Airport.prototype.icao=function(){return this._icao};Airport.prototype.iata=function(){return this._iata};Airport.prototype.lat=function(){return this._lat};Airport.prototype.lon=function(){return this._lon};Airport.prototype.elevation=function(){return this._elevation};function Autopilot(aircraft){this._aircraft=aircraft;this._runway;this._action={INACTIVE:1,VISUAL_APPROACH:2,ILS_APPROACH:3};this._state={LOOKING:1,AWAITING:2,ESTABLISHED_LOC:3,ESTABLISHED_GS:4,MISSED:5,INACTIVE:6};this._currentAction=this._action.INACTIVE;this._currentState=this._state.INACTIVE}Autopilot.prototype.engageILS=function(runway){this._runway=runway;this._currentAction=this._action.ILS_APPROACH;this._currentState=this._state.AWAITING};Autopilot.prototype.engageVisualApproach=function(runway){this._runway=runway;this._currentAction=this._action.VISUAL_APPROACH};Autopilot.prototype.fly=function(r){switch(this._currentAction){case this._action.ILS_APPROACH:this.flyILS(r);return true;case this._action.VISUAL_APPROACH:this.flyVisualApproach();return true;case this._action.INACTIVE:return false}};var hdg=257;Autopilot.prototype.flyILS=function(r){switch(this._currentState){case this._state.AWAITING:var distanceInKm=this._aircraft.position().distanceTo(this._runway.position());var distanceInFeet=distanceInKm*3280.84;console.log(this._runway.course(),r.magVar(),(this._runway.course()+r.magVar()+180)%360);var pos=this._runway.position().destinationPoint(hdg+180,distanceInKm);this._aircraft.setLat(pos._lat);this._aircraft.setLon(pos._lon);var gsAltitude=Math.tan(3*Math.PI/180)*distanceInFeet;this._aircraft.setAltitude(gsAltitude);break;case this._state.ESTABLISHED_LOC:break;case this._state.ESTABLISHED_GS:break;case this._state.MISSED:break}};Autopilot.prototype.flyVisualApproach=function(){switch(this._currentState){case this._state.LOOKING:break;case this._state.AWAITING:case this._state.ESTABLISHED_LOC:break;case this._state.ESTABLISHED_GS:break;case this._state.MISSED:break}};function Compass(){this._display=true;this._brite=5;this._notchLength=12}Compass.prototype.render=function(r){if(this._display){r.context().strokeStyle=r.brite(this._brite);r.context().lineWidth=1;var radius=Math.sqrt(Math.pow(r.scope().width/2,2)+Math.pow(r.scope().height/2,2));for(var i=0;i<360;i+=5){var from=(i-95)/180*Math.PI;var to=(i-90)/180*Math.PI;r.context().beginPath();r.context().arc(r.scope().width/2,r.scope().height/2,radius,from,to);r.context().lineTo(r.scope().width/2,r.scope().height/2);r.context().stroke()}r.context().beginPath();r.context().rect(this._notchLength,this._notchLength,r.scope().width-this._notchLength*2,r.scope().height-this._notchLength*2);r.context().fillStyle=r.background();r.context().fill();for(var i=0;i<360;i+=10){var radiusX=1/Math.abs(Math.cos(i/180*Math.PI))*(r.scope().height/2-(this._notchLength+15));var radiusY=1/Math.abs(Math.sin(i/180*Math.PI))*(r.scope().width/2-(this._notchLength+15));var radius=radiusX<radiusY?radiusX:radiusY;var angle=(i-90)/180*Math.PI;var x=r.scope().width/2+Math.cos(angle)*radius;var y=r.scope().height/2+Math.sin(angle)*radius;r.context().beginPath();r.context().font="10px Oxygen Mono";r.context().textAlign="center";r.context().textBaseline="middle";r.context().fillStyle=r.brite(this._brite);r.context().fillText(r.pad(i,3,true),x,y)}}};function ConflictDetectionEngine(){this._conflictStates={};this._conflicts={};this._audibleConflicts=0;this._alarmSounding=false;this._alarm=new Audio("../atc2/conflictalert.wav");this._separationMinima=[{anchor:null,radius:null,minAltitude:null,maxAltitude:17999,lateral:3,vertical:1e3},{anchor:null,radius:null,minAltitude:18e3,maxAltitude:null,lateral:5,vertical:1e3}];this._conflictState={NONE:1,ACTIVE:2,MUTED:3}}ConflictDetectionEngine.prototype.conflicts=function(){var identifiers=[];for(var id in this._conflictStates)if(this._conflictStates[id]!=this._conflictState.NONE)identifiers.push(id);return identifiers};ConflictDetectionEngine.prototype.manageAlarm=function(){if(this._audibleConflicts>0){if(!this._alarmSounding){this._alarmSounding=true;this._alarm.loop=true;this._alarm.play()}}else if(this._alarmSounding){this._alarmSounding=false;this._alarm.pause()}};ConflictDetectionEngine.prototype.singleAircraftInConflict=function(aircraft){if(this._conflicts[aircraft.callsign()])return true;else return false};ConflictDetectionEngine.prototype.detect=function(aircraft){var callsigns=Object.keys(aircraft);var numAircraft=callsigns.length;for(var i=0;i<numAircraft;i++){for(var j=i+1;j<numAircraft;j++){var localAircraft=aircraft[callsigns[i]];var foreignAircraft=aircraft[callsigns[j]];if(this.inConflict(localAircraft,foreignAircraft))this.addConflict(localAircraft,foreignAircraft);else this.removeConflict(localAircraft,foreignAircraft)}}};ConflictDetectionEngine.prototype.addConflict=function(localAircraft,foreignAircraft){var identifier=this.aircraftToIdentifier(localAircraft,foreignAircraft);if(!this._conflictStates[identifier]||this._conflictStates[identifier]==this._conflictState.NONE){this._conflictStates[identifier]=this._conflictState.ACTIVE;if(!this._conflicts[localAircraft.callsign()])this._conflicts[localAircraft.callsign()]=0;this._conflicts[localAircraft.callsign()]++;if(!this._conflicts[foreignAircraft.callsign()])this._conflicts[foreignAircraft.callsign()]=0;this._conflicts[foreignAircraft.callsign()]++;this._audibleConflicts++}};ConflictDetectionEngine.prototype.removeConflict=function(localAircraft,foreignAircraft){var identifier=this.aircraftToIdentifier(localAircraft,foreignAircraft);if(this._conflictStates[identifier]==this._conflictState.ACTIVE){this._conflictStates[identifier]=this._conflictState.NONE;this._conflicts[localAircraft.callsign()]--;this._conflicts[foreignAircraft.callsign()]--;this._audibleConflicts--}else if(this._conflictStates[identifier]==this._conflictState.MUTED){this._conflictStates[identifier]=this._conflictState.NONE;this._conflicts[localAircraft.callsign()]--;this._conflicts[foreignAircraft.callsign()]--}};ConflictDetectionEngine.prototype.muteAircraft=function(localAircraft,aircraft){if(this._audibleConflicts>0)for(var i in aircraft)this.muteConflict(localAircraft,aircraft[i])};ConflictDetectionEngine.prototype.muteConflict=function(localAircraft,foreignAircraft){var identifier=this.aircraftToIdentifier(localAircraft,foreignAircraft);if(this._conflictStates[identifier]==this._conflictState.ACTIVE){this._conflictStates[identifier]=this._conflictState.MUTED;this._audibleConflicts--;this.manageAlarm()}};ConflictDetectionEngine.prototype.unmuteConflict=function(localAircraft,foreignAircraft){var identifier=this.aircraftToIdentifier(localAircraft,foreignAircraft);if(this._conflictStates[identifier]==this._conflictState.MUTED){this._conflictStates[identifier]=this._conflictState.ACTIVE;this._audibleConflicts++;this.manageAlarm()}};ConflictDetectionEngine.prototype.aircraftToIdentifier=function(localAircraft,foreignAircraft){var aircraft=[localAircraft.callsign(),foreignAircraft.callsign()];aircraft.sort();return aircraft.join("*")};ConflictDetectionEngine.prototype.classifyMinima=function(localAircraft,foreignAircraft){var minima={lateral:0,vertical:0};for(var i in this._separationMinima){var m=this._separationMinima[i];if((m.lateral>minima.lateral||m.vertical>m.vertical)&&(!m.anchor||m.anchor)&&(!m.minAltitude||(localAircraft.altitude()>=m.minAltitude||foreignAircraft.altitude()>=m.minAltitude))&&(!m.maxAltitude||(localAircraft.altitude()<=m.maxAltitude||foreignAircraft.altitude()<=m.maxAltitude))){minima.lateral=Math.max(m.lateral,minima.lateral);minima.vertical=Math.max(m.vertical,minima.vertical)}}return minima};ConflictDetectionEngine.prototype.inConflict=function(localAircraft,foreignAircraft){var minima=this.classifyMinima(localAircraft,foreignAircraft);if(Math.abs(localAircraft.altitude()-foreignAircraft.altitude())>=minima.vertical)return false;var localPosition=new LatLon(localAircraft.lat(),localAircraft.lon());var foreignAircraft=new LatLon(foreignAircraft.lat(),foreignAircraft.lon());if(localPosition.distanceTo(foreignAircraft)*.539957>=minima.lateral)return false;return true};function CRDA(airport,masterRunwayID,slaveRunwayID,r){this._r=r;this._airport=airport;this._master=airport.runway(masterRunwayID);this._slave=airport.runway(slaveRunwayID)}CRDA.prototype.ghostAircraft=function(aircraft){if(this._master&&this.inMasterZone(aircraft))this.renderGhost(aircraft,this.ghostPosition(aircraft))};CRDA.prototype.ghostPosition=function(aircraft){var bearingOffset=360-(this._master.course()+this._r.magVar())+this._master.position().bearingTo(aircraft.position());var distance=this._master.position().distanceTo(aircraft.position());return this._slave.position().destinationPoint(this._slave.course()+this._r.magVar()+bearingOffset,distance)};CRDA.prototype.renderGhost=function(aircraft,position){var acPos=this._r.gtoc(position._lat,position._lon);this._r.context().fillStyle="#ff0";this._r.context().strokeStyle="#ff0";this._r.context().beginPath();this._r.context().font="bold "+14+"px Oxygen Mono";this._r.context().textAlign="center";this._r.context().textBaseline="middle";this._r.context().fillText("0",acPos.x,acPos.y);this._r.context().beginPath();this._r.context().moveTo(acPos.x-10,acPos.y);this._r.context().lineTo(acPos.x-40,acPos.y);this._r.context().lineWidth=1;this._r.context().stroke();this._r.context().beginPath();this._r.context().font="bold "+14+"px Oxygen Mono";this._r.context().textAlign="right";this._r.context().textBaseline="middle";var scopeSpeed=Math.floor(aircraft.groundspeed()/10);var scopeAltitude=Math.floor(aircraft.altitude()/100);this._r.context().fillText(this._r.pad(scopeSpeed,2),acPos.x-45,acPos.y)};CRDA.prototype.setMaster=function(runway){this._master=runway};CRDA.prototype.setSlave=function(runway){this._slave=runway};CRDA.prototype.master=function(){return this._master};CRDA.prototype.slave=function(){return this._slave};CRDA.prototype.airport=function(){return this._airport};CRDA.prototype.inMasterZone=function(aircraft){var distanceInFeet=aircraft.position().distanceTo(this._master.position())*3280.84;var radioAltitude=aircraft.altitude()-this._master.elevation();var gsAltitude=Math.tan(3*Math.PI/180)*distanceInFeet;if(aircraft.altitude()<gsAltitude+1e3&&this.angleBetween(aircraft.heading(),this._master.course())<90&&this.inMasterFunnel(aircraft))return true;return false};CRDA.prototype.angleBetween=function(primaryHeading,secondaryHeading){var gap=Math.abs(primaryHeading-secondaryHeading);return Math.min(gap,360-gap)};CRDA.prototype.inMasterFunnel=function(aircraft){var bearingOffset=(360-(this._master.course()+this._r.magVar())+this._master.position().bearingTo(aircraft.position()))%360;var distance=this._master.position().distanceTo(aircraft.position())*.539957;return 150<=bearingOffset&&bearingOffset<=210&&distance<=30};function Flow(){this._urlRoot="http://flightaware.com";this._paths=[];this._positionReports=[]}Flow.prototype.altitude=function(position){var forceReports=[];var minDistance=5;for(var i in this._positionReports){var report=this._positionReports[i];var distance=report.position.distanceTo(position)*.539957;if(distance<=5){report.distance=distance;forceReports.push(report);if(distance<minDistance)minDistance=distance}}if(forceReports.length==0)return-1;var altitudeSum=0;var totalWeight=0;for(var i in forceReports){var report=forceReports[i];var weight=Math.pow(minDistance/report.distance,.5);console.log(weight);altitudeSum+=report.altitude*weight;totalWeight+=weight}return altitudeSum/totalWeight};Flow.prototype.countInRange=function(position,range){var count=0;for(var i in this._positionReports){var distance=this._positionReports[i].position.distanceTo(position)*.539957;if(distance<=range)count++}return count};Flow.prototype.loadRecent=function(airport,limit,cb){var flow=this;for(var o=0;o<200;o+=20){$.post("/sandbox/sim/feeds/proxy.php",{url:this._urlRoot+"/live/airport/KBOS/arrivals?;offset="+o},function(data){var flights=data.match(/\/live\/flight\/\w+/g);for(var i=1;i<flights.length;i++){(function(i){$.post("/sandbox/sim/feeds/proxy.php",{url:flow._urlRoot+flights[i]},function(data){var path=data.match(/data-target='(.+?)' style/);var link=flow._urlRoot+path[1]+"/tracklog";$.post("/sandbox/sim/feeds/proxy.php",{url:link},function(data){var path=[];var rows=data.match(/<tr class="smallrow[12]{1}">[\s\S]+?<\/tr>/g);for(var i in rows){var row=rows[i];var position=row.match(/<td align="center">(.+?)<\/td>[\s\S]+?<td align="center">(.+?)<\/td>[\s\S]+?<td align="center">(.+?)<\/td>[\s\S]+?<td align="center">(.+?)&deg;<\/td>[\s\S]+?<td align="left">(.+?)<\/td>[\s\S]+?<td align="right">(.*?)<\/td>[\s\S]+?<td align="right">(.*?)<\/td>[\s\S]+?<td align="right">(.*?)<\/td>[\s\S]+?<td align="right">(.*?)&nbsp;/);var time=position[1];var lat=parseFloat(position[2]);var lon=parseFloat(position[3]);var course=parseInt(position[4]);var direction=position[5];var groundspeed=parseInt(position[6]);var groundspeedMPH=parseInt(position[7]);var altitude=parseInt(position[8].replace(",",""));flow._positionReports.push({position:new LatLon(lat,lon),heading:course,speed:groundspeed,altitude:altitude});console.log("added")}var position=data.match(/"center">(.+?)</g);var numPositionReports=position.length/4;for(var i=0;i<numPositionReports;i++){var latMatch=position[i*4+1].match(/>(.+?)</);var lonMatch=position[i*4+2].match(/>(.+?)</);path[i]=[parseFloat(latMatch[1]),parseFloat(lonMatch[1])]}flow._paths.push(path)},"html")},"html")})(i)}},"html")}};Flow.prototype.loadRecent2=function(airport,limit,cb){var flow=this;$.post("/sandbox/sim/feeds/proxy.php",{url:this._urlRoot+"/live/flight/SKV7384"},function(data){var pathString=data.match(/trackstring = ({.+});/);var pathObject=JSON.parse(pathString[1]);var path=pathObject.features[2].geometry.coordinates;for(var i in path){var temp=path[i][0];path[i][0]=path[i][1];path[i][1]=temp}flow._paths["SKV73841"]=path;cb(path)},"html")};Flow.prototype.renderPath=function(path,r){r.context().lineWidth=1.5;r.context().strokeStyle="rgba(255, 255, 0, .1)";r.context().beginPath();var start=r.gtoc(path[0][0],path[0][1]);r.context().moveTo(start.x,start.y);for(var i=1;i<path.length;i++){var next=r.gtoc(path[i][0],path[i][1]);r.context().lineTo(next.x,next.y)}r.context().stroke()};Flow.prototype.render=function(r){for(var i in this._paths)this.renderPath(this._paths[i],r)};function RWTraffic(airport,situation,r){this._r=r;this._airport=airport;this._situation=situation;this._airports={};this._inRequest={}}RWTraffic.prototype.inbound=function(distance,cb){var icao=this._airport.icao();if(this._airports[icao]&&this._airports[icao].inbound&&this._airports[icao].inbound.lastUpdate>=(new Date).getTime()-15*1e3){cb(this._airports[icao].inbound.aircraft,this._airports[icao].inbound.lastUpdate);return}else if(this._inRequest[icao])return;this._inRequest[icao]=true;var self=this;$.post("/sandbox/sim/feeds/proxy.php",{url:"http://flightaware.com/live/airport/"+icao},function(data){var jsonInbound=data.match(/json_inbound = ({.+});/);var arrivals=JSON.parse(jsonInbound[1]);var aircraftList={};for(var i in arrivals.features){var aircraft=arrivals.features[i];if(aircraft.properties.projected===0){var inboundAircraft=new Aircraft(aircraft.properties.ident);inboundAircraft.setType(aircraft.properties.type);inboundAircraft.setCategory("J");inboundAircraft.setFlightRules("I");inboundAircraft.setArrival(aircraft.properties.destination);inboundAircraft.setLat(aircraft.geometry.coordinates[1]);inboundAircraft.setLon(aircraft.geometry.coordinates[0]);inboundAircraft.setAltitude(aircraft.properties.altitude*100);inboundAircraft.setHeading((aircraft.properties.direction+180-self._r.magVar())%360);inboundAircraft.setSpeed(inboundAircraft.airspeed(aircraft.properties.groundspeed));inboundAircraft.setLastSimulated(self._situation.elapsed());inboundAircraft.performance().loadFromCategory(inboundAircraft.category());if(inboundAircraft.position().distanceTo(self._airport.position())*.539957<distance)aircraftList[inboundAircraft.callsign()]=inboundAircraft}}if(self._airports[icao]===undefined)self._airports[icao]={};self._airports[icao].inbound={lastUpdate:(new Date).getTime(),aircraft:aircraftList};self._inRequest[icao]=false;cb(aircraftList,self._airports[icao].inbound.lastUpdate)},"html")};function LatLon(lat,lon,rad){if(typeof rad=="undefined")rad=6371;this._lat=typeof lat=="number"?lat:typeof lat=="string"&&lat.trim()!=""?+lat:NaN;this._lon=typeof lon=="number"?lon:typeof lon=="string"&&lon.trim()!=""?+lon:NaN;this._radius=typeof rad=="number"?rad:typeof rad=="string"&&trim(lon)!=""?+rad:NaN}LatLon.prototype.distanceTo=function(point,precision){if(typeof precision=="undefined")precision=4;var R=this._radius;var lat1=this._lat.toRad(),lon1=this._lon.toRad();var lat2=point._lat.toRad(),lon2=point._lon.toRad();var dLat=lat2-lat1;var dLon=lon2-lon1;var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));var d=R*c;return d.toPrecisionFixed(precision)};LatLon.prototype.bearingTo=function(point){var lat1=this._lat.toRad(),lat2=point._lat.toRad();var dLon=(point._lon-this._lon).toRad();var y=Math.sin(dLon)*Math.cos(lat2);var x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);var brng=Math.atan2(y,x);return(brng.toDeg()+360)%360};LatLon.prototype.finalBearingTo=function(point){var lat1=point._lat.toRad(),lat2=this._lat.toRad();var dLon=(this._lon-point._lon).toRad();var y=Math.sin(dLon)*Math.cos(lat2);var x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);var brng=Math.atan2(y,x);return(brng.toDeg()+180)%360};LatLon.prototype.midpointTo=function(point){lat1=this._lat.toRad(),lon1=this._lon.toRad();lat2=point._lat.toRad();var dLon=(point._lon-this._lon).toRad();var Bx=Math.cos(lat2)*Math.cos(dLon);var By=Math.cos(lat2)*Math.sin(dLon);lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+Bx)*(Math.cos(lat1)+Bx)+By*By));lon3=lon1+Math.atan2(By,Math.cos(lat1)+Bx);lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat3.toDeg(),lon3.toDeg())};LatLon.prototype.destinationPoint=function(brng,dist){dist=typeof dist=="number"?dist:typeof dist=="string"&&dist.trim()!=""?+dist:NaN;dist=dist/this._radius;brng=brng.toRad();var lat1=this._lat.toRad(),lon1=this._lon.toRad();
var lat2=Math.asin(Math.sin(lat1)*Math.cos(dist)+Math.cos(lat1)*Math.sin(dist)*Math.cos(brng));var lon2=lon1+Math.atan2(Math.sin(brng)*Math.sin(dist)*Math.cos(lat1),Math.cos(dist)-Math.sin(lat1)*Math.sin(lat2));lon2=(lon2+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat2.toDeg(),lon2.toDeg())};LatLon.intersection=function(p1,brng1,p2,brng2){brng1=typeof brng1=="number"?brng1:typeof brng1=="string"&&trim(brng1)!=""?+brng1:NaN;brng2=typeof brng2=="number"?brng2:typeof brng2=="string"&&trim(brng2)!=""?+brng2:NaN;lat1=p1._lat.toRad(),lon1=p1._lon.toRad();lat2=p2._lat.toRad(),lon2=p2._lon.toRad();brng13=brng1.toRad(),brng23=brng2.toRad();dLat=lat2-lat1,dLon=lon2-lon1;dist12=2*Math.asin(Math.sqrt(Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2)));if(dist12==0)return null;brngA=Math.acos((Math.sin(lat2)-Math.sin(lat1)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat1)));if(isNaN(brngA))brngA=0;brngB=Math.acos((Math.sin(lat1)-Math.sin(lat2)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat2)));if(Math.sin(lon2-lon1)>0){brng12=brngA;brng21=2*Math.PI-brngB}else{brng12=2*Math.PI-brngA;brng21=brngB}alpha1=(brng13-brng12+Math.PI)%(2*Math.PI)-Math.PI;alpha2=(brng21-brng23+Math.PI)%(2*Math.PI)-Math.PI;if(Math.sin(alpha1)==0&&Math.sin(alpha2)==0)return null;if(Math.sin(alpha1)*Math.sin(alpha2)<0)return null;alpha3=Math.acos(-Math.cos(alpha1)*Math.cos(alpha2)+Math.sin(alpha1)*Math.sin(alpha2)*Math.cos(dist12));dist13=Math.atan2(Math.sin(dist12)*Math.sin(alpha1)*Math.sin(alpha2),Math.cos(alpha2)+Math.cos(alpha1)*Math.cos(alpha3));lat3=Math.asin(Math.sin(lat1)*Math.cos(dist13)+Math.cos(lat1)*Math.sin(dist13)*Math.cos(brng13));dLon13=Math.atan2(Math.sin(brng13)*Math.sin(dist13)*Math.cos(lat1),Math.cos(dist13)-Math.sin(lat1)*Math.sin(lat3));lon3=lon1+dLon13;lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat3.toDeg(),lon3.toDeg())};LatLon.prototype.rhumbDistanceTo=function(point){var R=this._radius;var lat1=this._lat.toRad(),lat2=point._lat.toRad();var dLat=(point._lat-this._lat).toRad();var dLon=Math.abs(point._lon-this._lon).toRad();var dPhi=Math.log(Math.tan(lat2/2+Math.PI/4)/Math.tan(lat1/2+Math.PI/4));var q=isFinite(dLat/dPhi)?dLat/dPhi:Math.cos(lat1);if(Math.abs(dLon)>Math.PI){dLon=dLon>0?-(2*Math.PI-dLon):2*Math.PI+dLon}var dist=Math.sqrt(dLat*dLat+q*q*dLon*dLon)*R;return dist.toPrecisionFixed(4)};LatLon.prototype.rhumbBearingTo=function(point){var lat1=this._lat.toRad(),lat2=point._lat.toRad();var dLon=(point._lon-this._lon).toRad();var dPhi=Math.log(Math.tan(lat2/2+Math.PI/4)/Math.tan(lat1/2+Math.PI/4));if(Math.abs(dLon)>Math.PI)dLon=dLon>0?-(2*Math.PI-dLon):2*Math.PI+dLon;var brng=Math.atan2(dLon,dPhi);return(brng.toDeg()+360)%360};LatLon.prototype.rhumbDestinationPoint=function(brng,dist){var R=this._radius;var d=parseFloat(dist)/R;var lat1=this._lat.toRad(),lon1=this._lon.toRad();brng=brng.toRad();var dLat=d*Math.cos(brng);if(Math.abs(dLat)<1e-10)dLat=0;var lat2=lat1+dLat;var dPhi=Math.log(Math.tan(lat2/2+Math.PI/4)/Math.tan(lat1/2+Math.PI/4));var q=isFinite(dLat/dPhi)?dLat/dPhi:Math.cos(lat1);var dLon=d*Math.sin(brng)/q;if(Math.abs(lat2)>Math.PI/2)lat2=lat2>0?Math.PI-lat2:-Math.PI-lat2;lon2=(lon1+dLon+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat2.toDeg(),lon2.toDeg())};LatLon.prototype.rhumbMidpointTo=function(point){lat1=this._lat.toRad(),lon1=this._lon.toRad();lat2=point._lat.toRad(),lon2=point._lon.toRad();if(Math.abs(lon2-lon1)>Math.PI)lon1+=2*Math.PI;var lat3=(lat1+lat2)/2;var f1=Math.tan(Math.PI/4+lat1/2);var f2=Math.tan(Math.PI/4+lat2/2);var f3=Math.tan(Math.PI/4+lat3/2);var lon3=((lon2-lon1)*Math.log(f3)+lon1*Math.log(f2)-lon2*Math.log(f1))/Math.log(f2/f1);if(!isFinite(lon3))lon3=(lon1+lon2)/2;lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat3.toDeg(),lon3.toDeg())};LatLon.prototype.lat=function(format,dp){if(typeof format=="undefined")return this._lat;return Geo.toLat(this._lat,format,dp)};LatLon.prototype.lon=function(format,dp){if(typeof format=="undefined")return this._lon;return Geo.toLon(this._lon,format,dp)};LatLon.prototype.toString=function(format,dp){if(typeof format=="undefined")format="dms";return Geo.toLat(this._lat,format,dp)+", "+Geo.toLon(this._lon,format,dp)};if(typeof Number.prototype.toRad=="undefined"){Number.prototype.toRad=function(){return this*Math.PI/180}}if(typeof Number.prototype.toDeg=="undefined"){Number.prototype.toDeg=function(){return this*180/Math.PI}}if(typeof Number.prototype.toPrecisionFixed=="undefined"){Number.prototype.toPrecisionFixed=function(precision){var n=this.toPrecision(precision);n=n.replace(/(.+)e\+(.+)/,function(n,sig,exp){sig=sig.replace(/\./,"");l=sig.length-1;while(exp-->l)sig=sig+"0";return sig});n=n.replace(/(.+)e-(.+)/,function(n,sig,exp){sig=sig.replace(/\./,"");while(exp-->1)sig="0"+sig;return"0."+sig});return n}}if(typeof String.prototype.trim=="undefined"){String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")}}function Map(filename,r,callback){this._path=[];this._brite=2;if(typeof filename=="string")this.loadFromFile(filename,r,callback)}Map.prototype.loadFromFile=function(filename,r,callback){var map=this;$.get(filename,function(data){map.addMapPath(data.split("\n"),r);callback()})};Map.prototype.addMapPath=function(pathList,r){for(var line in pathList){var lineData=$.trim(pathList[line]).split(" ");if(lineData.length>=4){var subpath=[];for(var i in lineData){if(i<4){var lineDataParts=lineData[i].split(".");var p1=parseInt(lineDataParts[0].replace("N","+").replace("E","+").replace("S","-").replace("W","-"));var p2=parseInt(lineDataParts[1].replace("N","+").replace("E","+").replace("S","-").replace("W","-"));var p3=parseInt(lineDataParts[2].replace("N","+").replace("E","+").replace("S","-").replace("W","-"));var p4=parseInt(lineDataParts[3].replace("N","+").replace("E","+").replace("S","-").replace("W","-"));if(p1<0){subpath[i]=-1*(-1*p1+p2/60+parseFloat(p3+"."+p4)/3600)}else{subpath[i]=p1+p2/60+parseFloat(p3+"."+p4)/3600}}}r.setMinLat(Math.min(r.minLat(),subpath[0],subpath[2]));r.setMinLon(Math.min(r.minLon(),subpath[1],subpath[3]));r.setMaxLat(Math.max(r.maxLat(),subpath[0],subpath[2]));r.setMaxLon(Math.max(r.maxLon(),subpath[1],subpath[3]));this._path[line]=subpath}}var scopeCorner=new LatLon(r.minLat(),r.minLon());var scopeMidpoint=scopeCorner.midpointTo(new LatLon(r.maxLat(),r.maxLon()));r.setMidLat(scopeMidpoint._lat);r.setMidLon(scopeMidpoint._lon)};Map.prototype.render=function(r){r.context().lineWidth=1.5;r.context().strokeStyle=r.brite(this._brite);for(var line in this._path){var from=r.gtoc(this._path[line][0],this._path[line][1]);var to=r.gtoc(this._path[line][2],this._path[line][3]);r.context().beginPath();r.context().moveTo(from.x,from.y);r.context().lineTo(to.x,to.y);r.context().stroke()}};function Renderer(){this._created=(new Date).getTime();this._targetHistory=true;this._last=this._created;this._scope;this._context;this._background="#000";this._magVar=-15.24;this._minLat=90;this._minLon=180;this._midLat=0;this._midLon=0;this._maxLat=-90;this._maxLon=-180;this._globalScale=1;this._radarCenter={};this._translation={lastMousePosition:{x:0,y:0},offset:{x:0,y:0}};this._presets=[];this._mouseDown=false}Renderer.prototype.bind=function(scope){this._scope=$(scope)[0];this._context=this._scope.getContext("2d")};Renderer.prototype.scope=function(){return this._scope};Renderer.prototype.context=function(){return this._context};Renderer.prototype.inBounds=function(lat,lon){var pos=this.gtoc(lat,lon);return pos.x>=0&&pos.y>=0&&pos.x<=this._scope.width&&pos.y<=this._scope.height};Renderer.prototype.elapsed=function(){return(new Date).getTime()-this._created};Renderer.prototype.enableTargetHistory=function(){this._targetHistory=true};Renderer.prototype.disableTargetHistory=function(){this._targetHistory=false};Renderer.prototype.targetHistory=function(){return this._targetHistory};Renderer.prototype.setMinLat=function(minLat){this._minLat=minLat};Renderer.prototype.setMinLon=function(minLon){this._minLon=minLon};Renderer.prototype.setMidLat=function(midLat){this._midLat=midLat};Renderer.prototype.setMidLon=function(midLon){this._midLon=midLon};Renderer.prototype.setMaxLat=function(maxLat){this._maxLat=maxLat};Renderer.prototype.setMaxLon=function(maxLon){this._maxLon=maxLon};Renderer.prototype.minLat=function(){return this._minLat};Renderer.prototype.minLon=function(){return this._minLon};Renderer.prototype.midLat=function(){return this._midLat};Renderer.prototype.midLon=function(){return this._midLon};Renderer.prototype.maxLat=function(){return this._maxLat};Renderer.prototype.maxLon=function(){return this._maxLon};Renderer.prototype.scope=function(){return this._scope};Renderer.prototype.context=function(){return this._context};Renderer.prototype.background=function(){return this._background};Renderer.prototype.radarCenter=function(){var lat,lon;if(this._radarCenter.lat){lat=this._radarCenter.lat;lon=this._radarCenter.lon}else{lat=this._midLat;lon=this._midLon}return this.gtoc(lat,lon)};Renderer.prototype.radarCenterPosition=function(){var lat,lon;if(this._radarCenter.lat){lat=this._radarCenter.lat;lon=this._radarCenter.lon}else{lat=this._midLat;lon=this._midLon}return new LatLon(lat,lon)};Renderer.prototype.setRadarCenter=function(lat,lon){this._radarCenter={lat:lat,lon:lon}};Renderer.prototype.magVar=function(){return this._magVar};Renderer.prototype.setMagVar=function(magVar){this._magVar=magVar};Renderer.prototype.globalScale=function(){return this._globalScale};Renderer.prototype.setGlobalScale=function(globalScale){this._globalScale=globalScale};Renderer.prototype.lastMousePosition=function(){return this._translation.lastMousePosition};Renderer.prototype.setLastMousePosition=function(lastMousePosition){this._translation.lastMousePosition=lastMousePosition};Renderer.prototype.translationOffset=function(){return this._translation.offset};Renderer.prototype.setTranslationOffset=function(translationOffset){this._translation.offset=translationOffset};Renderer.prototype.mouseDown=function(){return this._mouseDown};Renderer.prototype.setMouseDown=function(mouseDown){this._mouseDown=mouseDown};Renderer.prototype.latRange=function(){return this._maxLat-this._minLat};Renderer.prototype.lonRange=function(){return this._maxLon-this._minLon};Renderer.prototype.scaledLatRange=function(lat){return this.latRange()*(1/Math.cos(lat/180*Math.PI))};Renderer.prototype.multiplier=function(lat){return this._scope.height/this.scaledLatRange(lat)};Renderer.prototype.scaleX=function(lat,lon){return this.gtoc(lat,lon).x};Renderer.prototype.scaleY=function(lat,lon){return this.gtoc(lat,lon).y};Renderer.prototype.brite=function(brite){return"#"+brite*111};Renderer.prototype.rotate=function(x,y,cx,cy,theta){var rx=x-cx;var ry=y-cy;theta*=-1;var fx=Math.cos(theta)*rx-Math.sin(theta)*ry;var fy=Math.sin(theta)*rx+Math.cos(theta)*ry;var mx=fx+cx;var my=fy+cy;return{x:mx,y:my}};Renderer.prototype.gtoc=function(lat,lon){var multiplier=this.multiplier(lat);var tx=multiplier*(lon-this._minLon)+this._scope.width/2-this.lonRange()*multiplier/2;var ty=this._scope.height-multiplier*(1/Math.cos(lat/180*Math.PI))*(lat-this._minLat);var rx=tx-this._scope.width/2;var ry=this._scope.height/2-ty;var theta=this._magVar/180*Math.PI;var fx=(Math.cos(theta)*rx-Math.sin(theta)*ry)*this._globalScale+this._translation.offset.x*this._globalScale;var fy=(Math.sin(theta)*rx+Math.cos(theta)*ry)*this._globalScale+this._translation.offset.y*this._globalScale;var mx=fx+this._scope.width/2;var my=this._scope.height/2-fy;return{x:mx,y:my}};Renderer.prototype.ctop=function(x,y){var fy=this._scope.height/2-y;var fx=x-this._scope.width/2;var bry=(fy-this._translation.offset.y*this._globalScale)/this._globalScale;var brx=(fx-this._translation.offset.x*this._globalScale)/this._globalScale;var theta=this._magVar/180*Math.PI;var ry=(Math.cos(theta)*bry-Math.sin(theta)*brx)/(Math.pow(Math.sin(theta),2)+Math.pow(Math.cos(theta),2));var rx=(bry-Math.cos(theta)*ry)/Math.sin(theta);var ty=this._scope.height/2-ry;var tx=rx+this._scope.width/2;var lat=(this.latRange()*(this._scope.height-ty)+this._scope.height*this._minLat)/this._scope.height;var multiplier=this._scope.height*Math.cos(lat/180*Math.PI)/this.latRange();var lon=(2*tx-this._scope.width+2*this._minLon*multiplier+this.lonRange()*multiplier)/(2*multiplier);return new LatLon(lat,lon)};Renderer.prototype.setPreset=function(slot){this._presets[slot]={scale:this._globalScale,translation:{x:this._translation.offset.x,y:this._translation.offset.y}}};Renderer.prototype.selectPreset=function(slot){var preset=this._presets[slot];if(preset){this._globalScale=preset.scale;this._translation.offset=preset.translation}};Renderer.prototype.scale=function(value){return value/this._globalScale};Renderer.prototype.adjustForMagVar=function(){this._context.translate(this._scope.width/2,this._scope.height/2);this._context.rotate(-this._magVar/180*Math.PI);this._context.translate(-this._scope.width/2,-this._scope.height/2)};Renderer.prototype.pad=function(string,length,heading){s=string==0&&heading?360:string;var s="00000"+s;return s.substr(s.length-length)};Renderer.prototype.angleBetween=function(ax,ay,bx,by){return Math.atan2(ay-by,bx-ax)};function Runway(id,lat,lon,elevation,length,width,course){this._id=id;this._lat=lat;this._lon=lon;this._elevation=elevation;this._length=length;this._width=width;this._course=course;this._ILSCapable=false}Runway.prototype.enableILS=function(){this._ILSCapable=true};Runway.prototype.disableILS=function(){this._ILSCapable=false};Runway.prototype.hasILS=function(){return this._ILSCapable};Runway.prototype.id=function(){return this._id};Runway.prototype.position=function(){return new LatLon(this._lat,this._lon)};Runway.prototype.lat=function(){return this._lat};Runway.prototype.lon=function(){return this._lon};Runway.prototype.elevation=function(){return this._elevation};Runway.prototype.length=function(){return this._length};Runway.prototype.width=function(){return this._width};Runway.prototype.course=function(){return this._course};function Scope(){this._maps={};this._airports={};this._situation=new Situation;this._renderer=new Renderer;this._compass=new Compass;this._textOverlay=new TextOverlay(this);this._flow=new Flow}Scope.prototype.select=function(x,y){var aircraft=this._situation.select(x,y,this._renderer);if(aircraft){this._textOverlay.clearPreview();this._textOverlay.addPreviewChar(aircraft.callsign());this._textOverlay.addPreviewChar(" ");this.render();return true}this.render();return false};Scope.prototype.bind=function(scope){this._renderer.bind(scope)};Scope.prototype.addAirport=function(airport){this._airports[airport.icao()]=airport};Scope.prototype.airport=function(icao){return this._airports[icao]};Scope.prototype.addMap=function(map,callback){this._maps[map]=new Map(map,this._renderer,callback)};Scope.prototype.setSituation=function(situation){this._situation=typeof situation=="string"?new Situation(situation):situation};Scope.prototype.map=function(id){return this._maps[id]};Scope.prototype.situation=function(){return this._situation};Scope.prototype.renderer=function(){return this._renderer};Scope.prototype.compass=function(){return this._compass};Scope.prototype.textOverlay=function(){return this._textOverlay};Scope.prototype.fit=function(){this._renderer.scope().width=$(window).width();this._renderer.scope().height=$(window).height()};Scope.prototype.renderBackground=function(){this._renderer.context().fillStyle=this._renderer.background();this._renderer.context().fillRect(0,0,this._renderer.scope().width,this._renderer.scope().height)};Scope.prototype.renderOverlays=function(){this._textOverlay.renderTime(this._renderer,this._airports);this._textOverlay.renderTowerList(this._renderer,this._airports,this._situation.aircraft());this._textOverlay.renderLACAMCI(this._renderer,this._situation.CDE());this._textOverlay.renderCRDAStatus(this._renderer,this._situation.CRDA());this._textOverlay.renderPreviewArea(this._renderer)};Scope.prototype.render=function(){this.fit();this.renderBackground();this._compass.render(this._renderer);for(var i in this._maps)this._maps[i].render(this._renderer);this._flow.render(this._renderer);this._situation.render(this._renderer);this.renderOverlays()};function Situation(situation){this._aircraft={};this._situation;this._paused=true;this._lastRun=0;this._elapsed=0;this._cde=new ConflictDetectionEngine;this._crda;this._conflictsEnabled=false;this._slaveFeed;this._slaveMode=false;this._slaveFeedUpdated=0;this._lastSlaveFeedAircraftList={};if(typeof situation=="string")this.loadFromFile(situation)}Situation.prototype.setSlaveFeed=function(feed){this._slaveFeed=feed};Situation.prototype.enableSlaveMode=function(){this._slaveMode=true};Situation.prototype.disableSlaveMode=function(){this._slaveMode=false};Situation.prototype.setCRDA=function(crda){this._crda=crda};Situation.prototype.CRDA=function(){return this._crda};Situation.prototype.CDE=function(){return this._cde};Situation.prototype.aircraft=function(callsign){return callsign?this._aircraft[callsign]:this._aircraft};Situation.prototype.loadFromFile=function(filename){var situation=this;$.get(filename,function(data){situation._situation=data.split("\n");situation.load()})};Situation.prototype.load=function(){this._aircraft={};for(var i in this._situation){var aircraft=new Aircraft(this._situation[i]);this._aircraft[aircraft.callsign()]=aircraft}};Situation.prototype.elapsed=function(){return this._elapsed+(this._paused?0:(new Date).getTime()-this._lastRun)};Situation.prototype.run=function(){if(this._paused){this._paused=false;this._lastRun=(new Date).getTime()}};Situation.prototype.pause=function(){if(!this._paused){this._paused=true;this._elapsed+=(new Date).getTime()-this._lastRun}};Situation.prototype.select=function(x,y,r){var callsigns=Object.keys(this._aircraft);var numAircraft=callsigns.length;var selectedAircraft=null;var i=0;for(i;i<numAircraft;i++){this._aircraft[callsigns[i]].deselect();var coordinates=r.gtoc(this._aircraft[callsigns[i]].lat(),this._aircraft[callsigns[i]].lon());var dx=coordinates.x-x;var dy=coordinates.y-y;var distance=Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));if(distance<15){selectedAircraft=this._aircraft[callsigns[i]];selectedAircraft.select();this._cde.muteAircraft(selectedAircraft,this._aircraft);break}}for(i=i+1;i<numAircraft;i++)this._aircraft[callsigns[i]].deselect();return selectedAircraft};Situation.prototype.detectAndRenderConflicts=function(){if(this._conflictsEnabled){this._cde.detect(this._aircraft);for(var i in this._aircraft)this._aircraft[i].setConflicting(this._cde.singleAircraftInConflict(this._aircraft[i]));this._cde.manageAlarm()}};Situation.prototype.updateSlaveFeed=function(){if(this._slaveMode){var situation=this;this._slaveFeed.inbound(150,function(aircraft,updated){if(updated>situation._slaveFeedUpdated){situation._slaveFeedUpdated=updated;for(var callsign in situation._aircraft){if(aircraft[callsign])situation._aircraft[callsign].update(aircraft[callsign],this._lastSlaveFeedAircraftList,situation.elapsed());else delete situation._aircraft[callsign]}for(var callsign in aircraft)if(situation._aircraft[callsign]===undefined)situation._aircraft[callsign]=aircraft[callsign];this._lastSlaveFeedAircraftList=aircraft}})}};Situation.prototype.render=function(r){this.updateSlaveFeed();var elapsedRenderer=r.elapsed();var elapsedSituation=this.elapsed();for(var i in this._aircraft)this._aircraft[i].fly(r,elapsedSituation);var aircraftInRange=[];this.detectAndRenderConflicts();for(var i in this._aircraft){if(this._crda)this._crda.ghostAircraft(this._aircraft[i]);if(r.inBounds(this._aircraft[i].lat(),this._aircraft[i].lon()))aircraftInRange.push(this._aircraft[i])}for(var i in aircraftInRange)aircraftInRange[i].renderHistory(r);for(var i in aircraftInRange)aircraftInRange[i].renderTarget(r);for(var i in aircraftInRange)aircraftInRange[i].renderPosition(r);for(var i in aircraftInRange)aircraftInRange[i].renderDataBlock(r,elapsedRenderer)};function TextOverlay(scope){this._scope=scope;this._preview=[""];this._formatError=false;this._previewLine=6;this._clock=new Date;this._brite=3;var textOverlay=this;setInterval(function(){textOverlay._clock=new Date},1e3)}TextOverlay.prototype.aircraftSelect=function(){if(this._preview.length==1){var aircraft;for(var callsign in this._scope.situation().aircraft()){if(callsign.lastIndexOf(this._preview[0])+this._preview[0].length==callsign.length){if(aircraft)return;else aircraft=this._scope.situation().aircraft(callsign)}}if(aircraft){this._preview[0]=aircraft.callsign();this.addPreviewChar(" ")}}};TextOverlay.prototype.processPreviewArea=function(){if(this._preview.length==3){var aircraft=this._scope.situation().aircraft(this._preview[0]);var command=this._preview[1];var parameter=this._preview[2];console.log("a");if(aircraft&&!isNaN(parameter)){console.log("b");switch(command){case"TL":case"TR":case"FH":if(0<=parameter&&parameter<=360){aircraft.assignHeading(parameter,this._scope.situation().elapsed(),0);this.clearPreview();return}break;case"CM":case"DM":if(0<=parameter&&parameter<=99999){aircraft.assignAltitude(parameter,this._scope.situation().elapsed(),0);this.clearPreview();return}break;case"SPD":case"SLOW":if(0<=parameter&&parameter<=9999){aircraft.assignSpeed(parameter,this._scope.situation().elapsed(),0);this.clearPreview();return}break}}}this._formatError=true};TextOverlay.prototype.clearPreview=function(){this._preview=[""];this._formatError=false};TextOverlay.prototype.addPreviewChar=function(character){if(character==" "){if(this._preview[this._preview.length-1]!="")this._preview.push("")}else this._preview[this._preview.length-1]+=character;this._formatError=false};TextOverlay.prototype.removePreviewChar=function(){if(this._preview[this._preview.length-1].length==0){this._preview.splice(this._preview.length-1);if(this._preview.length==0)this.clearPreview()}else this._preview[this._preview.length-1]=this._preview[this._preview.length-1].substr(0,this._preview[this._preview.length-1].length-1);this._formatError=false};TextOverlay.prototype.brite=function(red){if(red)return"rgb("+Math.round(255*this._brite/10)+", 0, 0)";return"rgb(0, "+Math.round(255*this._brite/10)+", 0)"};TextOverlay.prototype.line=function(r,top,line){return r.scope().height*top+line*20};TextOverlay.prototype.renderPreviewArea=function(r){r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="top";r.context().fillStyle=this.brite();if(this._formatError)r.context().fillText("FORMAT",75,this.line(r,.14,this._previewLine-1));for(var i=0;i<this._preview.length;i++)r.context().fillText(this._preview[i],75,this.line(r,.14,this._previewLine+i))};TextOverlay.prototype.renderTime=function(r,airports){var ICAOs=Object.keys(airports);var iata=airports[ICAOs[0]].iata();r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="top";r.context().fillStyle=this.brite();var date=this._clock;var hours=""+date.getUTCHours();var minutes=""+date.getUTCMinutes();var seconds=""+date.getUTCSeconds();var timeString=(hours.length==1?"0"+hours:hours)+(minutes.length==1?"0"+minutes:minutes)+"/"+(seconds.length==1?"0"+seconds:seconds);r.context().fillText(timeString+" --.--",75,this.line(r,.14,0));r.context().fillStyle=this.brite(true);r.context().fillText("NA/NA/NA ",75,this.line(r,.14,1));r.context().fillStyle=this.brite();r.context().fillText(iata,75+r.context().measureText("NA/NA/NA ").width,this.line(r,.14,1));r.context().fillText("22NM PTL: 3.0",75,this.line(r,.14,2));r.context().fillText("N99 999 U N99 999 A",75,this.line(r,.14,3));for(var i=0;i<ICAOs.length;i++)r.context().fillText(airports[ICAOs[i]].iata()+" --.--",75,this.line(r,.14,4+i));this._previewLine=6+ICAOs.length};TextOverlay.prototype.renderLACAMCI=function(r,cde){r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="top";r.context().fillStyle=this.brite();var textLeft=r.scope().width-200;r.context().fillText("LA/CA/MCI",textLeft,this.line(r,.8,0));var conflicts=cde.conflicts();for(var i=0;i<conflicts.length;i++)r.context().fillText(conflicts[i]+" CA",textLeft,this.line(r,.8,1+i))};TextOverlay.prototype.renderTowerList=function(r,airports,aircraft){var ICAOs=Object.keys(airports);var airport=airports[ICAOs[0]];var callsigns=Object.keys(aircraft);var line=0;callsigns.sort(function(a,b){return aircraft[a].position().distanceTo(airport.position())-aircraft[b].position().distanceTo(airport.position())});r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="top";r.context().fillStyle=this.brite();r.context().fillText(airport.iata()+" TOWER",75,this.line(r,.45,line++));if(callsigns.length>6)r.context().fillText("MORE: 6/"+callsigns.length,75,this.line(r,.45,line++));callsigns.splice(6);for(var i=0;i<callsigns.length;i++){var callsignString=callsigns[i];for(var j=0;j<7-callsigns[i].length;j++)callsignString+=" ";r.context().fillText(callsignString+" "+aircraft[callsigns[i]].type(),75,this.line(r,.45,line+i))}};TextOverlay.prototype.renderCRDAStatus=function(r,crda){r.context().beginPath();r.context().font="bold "+14+"px Oxygen Mono";r.context().textAlign="left";r.context().textBaseline="top";r.context().fillStyle=this.brite();r.context().fillText("CRDA STATUS",75,this.line(r,.8,0));if(crda)r.context().fillText(" 1 "+crda.airport().iata()+" "+crda.master().id()+"/"+crda.slave().id(),75,this.line(r,.8,1))};function WeatherOverlay(){this._overlays=[];this._weatherMarks=[];this._weatherGrid=[];this._contourGrid=[];this._weatherLoading=false}WeatherOverlay.prototype.refresh=function(r){var weatherOverlay=this;this.fetch(r,function(data){weatherOverlay._overlays.push(data)})};WeatherOverlay.prototype.fetch=function(r,callback){var baseURL="http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi";var requestData={service:"WMS",request:"GetMap",version:"1.1.1",format:"PNG",width:r.scope().width,height:r.scope().height,SRS:"EPSG:4326",bbox:r.minLon()+","+r.minLat()+","+r.maxLon()+","+r.maxLat(),layers:"nexrad-n0q-conus"};$.get(baseURL,requestData,function(data){callback(data)},"jsonp")};WeatherOverlay.prototype.render=function(r){if(this._overlays.length>0){r.context().save();r.context().globalAlpha=.5;for(var row in this._contourGrid){for(var col in this._contourGrid[row]){var wx=this._contourGrid[row][col];if(wx.precip>0){var pos=r.gtoc(wx.lat,wx.lon);r.context().beginPath();r.context().moveTo(pos.x-10,pos.y-10);r.context().lineTo(pos.x+10,pos.y-10);r.context().lineTo(pos.x+10,pos.y+10);r.context().lineTo(pos.x-10,pos.y+10);if(wx.precip<4)r.context().fillStyle="rgb(25, 50, 50)";else r.context().fillStyle="rgb(70, 70, 35)";r.context().fill();r.context().fillStyle="#fff";r.context().font="bold 14 px Arial";r.context().textAlign="center";r.context().textBaseline="middle";r.context().lineWidth=1;r.context().strokeStyle="rgb(100, 100, 100)";var theta=wx.lat*wx.lon;if(wx.precip%3==2){r.context().beginPath();r.context().moveTo(pos.x,pos.y);r.context().lineTo(pos.x+2*Math.cos(theta),pos.y+2*Math.sin(theta));r.context().stroke()}else if(wx.precip%3==0){r.context().beginPath();r.context().moveTo(pos.x-20/3,pos.y-20/3);r.context().lineTo(pos.x-20/3+2*Math.cos(theta),pos.y-20/3+2*Math.sin(theta));r.context().stroke();r.context().beginPath();r.context().moveTo(pos.x+20/3,pos.y-20/3);r.context().lineTo(pos.x+20/3+2*Math.cos(theta),pos.y-20/3+2*Math.sin(theta));r.context().stroke();r.context().beginPath();r.context().moveTo(pos.x+20/3,pos.y+20/3);r.context().lineTo(pos.x+20/3+2*Math.cos(theta),pos.y+20/3+2*Math.sin(theta));r.context().stroke();r.context().beginPath();r.context().moveTo(pos.x-20/3,pos.y+20/3);r.context().lineTo(pos.x-20/3+2*Math.cos(theta),pos.y+20/3+2*Math.sin(theta));r.context().stroke()}}}}r.context().restore()}else if(!this._weatherLoading){this._weatherLoading=true;var weatherOverlay=this;$.get("wx/wx.php",{bbox:r.minLon()-r.lonRange()*.1+","+(r.minLat()-r.latRange()*.1)+","+(r.maxLon()+r.lonRange()*.1)+","+(r.maxLat()+r.latRange()*.1)},function(){var img=new Image;img.src="wx/wx.gif";img.onload=function(){var imgData={data:weatherOverlay.imageToData(img)};var analyzed=0,marked=0,loop=0;var bottomLeft=new LatLon(r.minLat()-r.latRange()*.1,r.minLon()-r.lonRange()*.1);var topRight=new LatLon(r.maxLat()+r.latRange()*.1,r.maxLon()+r.lonRange()*.1);var geoHeight=bottomLeft.distanceTo(new LatLon(topRight._lat,bottomLeft._lon))*.539957;var latIncrement=(topRight._lat-bottomLeft._lat)/geoHeight/1;for(var latStep=0;latStep<topRight._lat-bottomLeft._lat;latStep+=latIncrement){var precipGridRow=[];var contourGridRow=[];var geoWidth=new LatLon(bottomLeft._lat+latStep,bottomLeft._lon).distanceTo(new LatLon(bottomLeft._lat+latStep,topRight._lon))*.539957;var lonIncrement=(topRight._lon-bottomLeft._lon)/geoWidth/1;for(var lonStep=0;lonStep<topRight._lon-bottomLeft._lon;lonStep+=lonIncrement){var x=Math.floor(lonStep/(topRight._lon-bottomLeft._lon)*2048);var y=img.height-Math.floor(latStep/(topRight._lat-bottomLeft._lat)*2048);var xRow=2048*4*y;var base=xRow+x*4;var alpha=imgData.data[base+3];var red=imgData.data[base];var green=imgData.data[base+1];var blue=imgData.data[base+2];var precipLevel=0;if(red<blue&&green<blue&&Math.abs(red-green)<50)precipLevel=1;else if(red<green&&red<blue&&Math.abs(green-blue)<100)precipLevel=2;else if(red<green&&green>blue&&Math.abs(red-blue)<50)precipLevel=3;else if(green>blue&&Math.abs(red-green)<50)precipLevel=4;else if(red>blue&&green>50&&Math.abs(green-blue)>50)precipLevel=5;else if(red>blue&&red>green&&Math.abs(green-blue)<50)precipLevel=6;weatherOverlay._weatherMarks.push(bottomLeft._lat+latStep);weatherOverlay._weatherMarks.push(bottomLeft._lon+lonStep);weatherOverlay._weatherMarks.push(precipLevel);weatherOverlay._weatherMarks.push(red);weatherOverlay._weatherMarks.push(green);weatherOverlay._weatherMarks.push(blue);precipGridRow.push({precip:precipLevel,lat:bottomLeft._lat+latStep,lon:bottomLeft._lon+lonStep,red:red,green:green,blue:blue});contourGridRow.push({precip:precipLevel,lat:bottomLeft._lat+latStep,lon:bottomLeft._lon+lonStep,red:red,green:green,blue:blue})}weatherOverlay._weatherGrid.push(precipGridRow);weatherOverlay._contourGrid.push(contourGridRow)}weatherOverlay._overlays.push(img)}})}};WeatherOverlay.prototype.weatherDataToSystems=function(data,r){var imgData=weatherOverlay.imageToData(img);var analyzed=0,marked=0,loop=0;var bottomLeft=new LatLon(r.minLat()-r.latRange()*.1,r.minLon()-r.lonRange()*.1);var topRight=new LatLon(r.maxLat()+r.latRange()*.1,r.maxLon()+r.lonRange()*.1);var geoHeight=bottomLeft.distanceTo(new LatLon(topRight._lat,bottomLeft._lon))*.539957;var latIncrement=(topRight._lat-bottomLeft._lat)/geoHeight;for(var latStep=0;latStep<topRight._lat-bottomLeft._lat;latStep+=latIncrement){var geoWidth=new LatLon(bottomLeft._lat+latStep,bottomLeft._lon).distanceTo(new LatLon(bottomLeft._lat+latStep,topRight._lon))*.539957;var lonIncrement=(topRight._lon-bottomLeft._lon)/geoWidth;for(var lonStep=0;lonStep<topRight._lon-bottomLeft._lon;lonStep+=lonIncrement){var x=Math.floor(lonStep/(topRight._lon-bottomLeft._lon)*2048);var y=img.height-Math.floor(latStep/(topRight._lat-bottomLeft._lat)*2048);var xRow=2048*4*y;var base=xRow+x*4;var alpha=imgData.data[base+3];if(alpha=="255"){weatherOverlay._weatherMarks.push(bottomLeft._lat+latStep);weatherOverlay._weatherMarks.push(bottomLeft._lon+lonStep);weatherOverlay._weatherMarks.push(imgData.data[base]);weatherOverlay._weatherMarks.push(imgData.data[base+1]);weatherOverlay._weatherMarks.push(imgData.data[base+2])}}}weatherOverlay._overlays.push(img)};WeatherOverlay.prototype.imageToData=function(img){var canvas=document.createElement("canvas");canvas.width=img.width;canvas.height=img.height;var context=canvas.getContext("2d");context.drawImage(img,0,0,img.width,img.height);
var imgData=context.getImageData(0,0,img.width,img.height);return imgData.data};