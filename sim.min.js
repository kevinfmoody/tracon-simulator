!function(){function t(t,e,n){this._r=n,this._airport=t,this._situation=e,this._airports={},this._inRequest={}}function e(){this._urlRoot="http://flightaware.com",this._paths=[],this._positionReports=[],this._aircraftPaths=[]}function n(t,e,n){"undefined"==typeof n&&(n=6371),this._lat="number"==typeof t?t:"string"==typeof t&&""!=t.trim()?+t:0/0,this._lon="number"==typeof e?e:"string"==typeof e&&""!=e.trim()?+e:0/0,this._radius="number"==typeof n?n:"string"==typeof n&&""!=trim(e)?+n:0/0}function i(){this.init.apply(this,arguments)}function o(){this._overlays=[],this._weatherMarks=[],this._weatherGrid=[],this._contourGrid=[],this._weatherLoading=!1}function r(t,e,n,i,o,r){this._icao=t,this._iata=e,this._lat=n,this._lon=i,this._elevation=o,this._magVar=r,this._runways={},this._metar=null,this._syncing=!1}function a(t,e,n,i,o,r,a,s){this._id=t,this._lat=e,this._lon=n,this._elevation=i,this._length=o,this._width=r,this._course=a,this._ILSCapable=s||!1}function s(){this._airports={},this._primaryAirport=""}function h(){this._display=!0,this._brite=5,this._notchLength=12}function c(t,e,n,i,o,r){this._position=t,this._targetCode=e,this._identifier=n,this._name=i,this._frequency=o,this._socket=r}function p(){this._conflictStates={},this._conflicts={},this._audibleConflicts=0,this._alarmSounding=!1,this._alarm=new Audio("../atc2/conflictalert.wav"),this._separationMinima=[{anchor:null,radius:null,minAltitude:null,maxAltitude:17999,lateral:3,vertical:1e3},{anchor:null,radius:null,minAltitude:18e3,maxAltitude:null,lateral:5,vertical:1e3}],this._conflictState={NONE:1,ACTIVE:2,MUTED:3}}function u(t,e,n){if(this._airport=t,this._master=t.runway(e),this._slave=t.runway(n),!this._master||!this._slave)throw u.ERROR.INVALID_RUNWAYS;this._enabled=!0}function f(){this._CRDAs=[],this._CRDAIdentifiers={},this._enabled=!0}function d(t,e,n,i,o){this._id=t,this._name=e,this._path=[],this._brite=5,this._enabled=!0,"string"==typeof n&&this.loadFromFile(n,i,o)}function g(t){this._scope=t,this._previewMessage="",this._preview=[""],this._formatError=!1,this._previewLine=6,this._clock=new Date,this._brite=3;var e=this;setInterval(function(){e._clock=new Date},1e3)}function y(){this._paths={},this._visiblePaths=[]}function T(t){this._name=t,this._waypoints=[]}function E(){this._position}function M(t){this._callsign=t,this._mode,this._type,this._position,this._arrival,this._altitude,this._speed,this._squawk,this._controller=null,this._history=[],this._coneSize,this._jRingSize,this._isExpanded=!1,this._isSelected=!1,this._isInConflict=!1,this._isDisplayingCone=!1,this._isDisplayingJRing=!1,this._isCoasting=!1,this._isAwaitingPurge=!1,this._ghostState=M.GHOST_STATES.ENABLED,this._otherController=null,this._controlStates={NORMAL:1,OWNED:2,INBOUND_HANDOFF:3,HANDOFF:4,POST_HANDOFF:5},this._controlState=this._controlStates.NORMAL,this._handoffTimeout,this._radarReturnTimeout,this._modes={OFF:1,STANDBY:2,ALTITUDE:3,IDENT:4},this._conflicts={},this._conflictState=M.CONFLICT_STATES.NONE}function x(){this._targets=[],this._airlines={},this._callsigns={},this._conflicts=[],this._alarmSounding=!1,this._alarm=new Audio("/sounds/ConflictAlert.wav"),this._targetPurger=setInterval(this.purgeTargets.bind(this),5e3)}function v(t){this._socket=t,this._maps={},this._airports={},this._targetManager=new x,this._facilityManager=new s,this._controller=null,this._controllers=[],this._radar=new E,this._renderer=new A,this._compass=new h,this._textOverlay=new g(this),this._flow=new e,this._pathManager=new y,this._radarManager=null,this._isOn=!1,this._CRDAManager=new f,this._sounds=!0,this._measureDistanceStartPosition=null,this._renderPoints=[],this._renderPointsBlinker=(new Date).getTime()}function S(t,e,n){this._id=t,this._name=e,this._scope=n,this._brite=5,this._enabled=!1,this._primaryAirport=null,this._paths=[],this._pathsByType={RUNWAY:[],LOCALIZER:[],COASTLINE:[],FIX:[],NAVAID:[]},this._yields={RUNWAY:[],LOCALIZER:[],NAVAID:[],FIX:[],COASTLINE:["RUNWAY","LOCALIZER"]},this.configure()}function A(){this._created=(new Date).getTime(),this._targetHistory=!0,this._last=this._created,this._scope,this._context,this._background="#000",this._magVar=0,this._minLat=90,this._minLon=180,this._midLat=0,this._midLon=0,this._maxLat=-90,this._maxLon=-180,this._globalScale=1,this._radarCenter={},this._translation={lastMousePosition:{x:0,y:0},offset:{x:0,y:0}},this._presets=[],this._mouseDown=!1}function O(t){this._target=t}function C(t){this._path=t}function m(t,e){this._scope=t,this._socket=e,this.bindServerListeners()}function R(){H.bind("#scope"),setInterval(function(){H.render()},1e3/30),H.facilityManager().setPrimaryAirport("KBOS"),H.facilityManager().primaryAirport(function(t){t&&(H.enableSmartMap(),H.radar().setPosition(t.position()),H.renderer().setRadarCenter(H.radar().position()),H.setControllerPosition("FEEDER",function(){H.turnOn()}))})}function P(){$("#scope").bind("mousewheel wheel",function(t){var e=1+t.originalEvent.wheelDelta/1e3;e=Math.min(Math.max(e,.5),2),H.renderer().setGlobalScale(H.renderer().globalScale()*e),H.render()})}function I(){$(window).resize(function(){H.render()})}function N(){$("#scope").bind("mousedown touchstart",function(t){return t="touchstart"==t.type?t.touches[0]:t,H.renderer().setMouseDown(!0),H.renderer().setLastMousePosition({x:t.clientX,y:t.clientY}),!1}),$("#scope").bind("mouseup mouseover mouseout touchend touchcancel",function(){H.renderer().setMouseDown(!1)}),$("#scope").bind("mousemove touchmove",function(t){return t="touchmove"===t.type?t.touches[0]:t,H.renderer().mouseDown()&&(H.renderer().dragging(),H.renderer().setTranslationOffset({x:H.renderer().translationOffset().x+H.renderer().scale(t.clientX-H.renderer().lastMousePosition().x),y:H.renderer().translationOffset().y+H.renderer().scale(H.renderer().lastMousePosition().y-t.clientY)}),H.renderer().setLastMousePosition({x:t.clientX,y:t.clientY}),H.render()),!1})}function w(){$("#scope").click(function(t){H.renderer().wasDragging()||Y.run(t,H.textOverlay().previewSegments())})}function L(){$(document).keypress(function(t){H.textOverlay().addPreviewChar(String.fromCharCode(t.which).toUpperCase()),H.render()}),$(document).keydown(function(t){if(t.which===B.KEYS.ENTER)t.preventDefault(),Y.run(t,H.textOverlay().previewSegments());else if(t.which===B.KEYS.SELECT_KEY)t.preventDefault();else{Y.cleanup();var e=B[t.which];if(e){var n=e[B.combo(t)];n&&(t.preventDefault(),n(t),H.render())}}}),$(document).keyup(function(t){t.which===B.KEYS.SELECT_KEY&&t.preventDefault()})}function b(){$(document).ready(function(){$("#setting-compass-brightness").change(function(){H.compass().setBrite($(this).val()),H.render()}),$("#setting-map-brightness").change(function(){for(var t in H.maps())H.maps()[t].setBrite($(this).val());H.render()})})}t.prototype.inbound=function(t,e){var n=this._airport.icao();if(this._airports[n]&&this._airports[n].inbound&&this._airports[n].inbound.lastUpdate>=(new Date).getTime()-15e3)return void e(this._airports[n].inbound.aircraft,this._airports[n].inbound.lastUpdate);if(!this._inRequest[n]){this._inRequest[n]=!0;var i=this;$.post("/sandbox/sim/feeds/proxy.php",{url:"http://flightaware.com/live/airport/"+n},function(o){var r=o.match(/json_inbound = ({.+});/),a=JSON.parse(r[1]),s={};for(var l in a.features){var h=a.features[l];if(0===h.properties.projected){var c=new Aircraft(h.properties.ident);c.setType(h.properties.type),c.setCategory("J"),c.setFlightRules("I"),c.setArrival(h.properties.destination),c.setLat(h.geometry.coordinates[1]),c.setLon(h.geometry.coordinates[0]),c.setAltitude(100*h.properties.altitude),c.setHeading((h.properties.direction+180-i._r.magVar())%360),c.setSpeed(c.airspeed(h.properties.groundspeed)),c.setLastSimulated(i._situation.elapsed()),c.performance().loadFromCategory(c.category()),.539957*c.position().distanceTo(i._airport.position())<t&&(s[c.callsign()]=c)}}void 0===i._airports[n]&&(i._airports[n]={}),i._airports[n].inbound={lastUpdate:(new Date).getTime(),aircraft:s},i._inRequest[n]=!1,e(s,i._airports[n].inbound.lastUpdate)},"html")}},e.ERROR={NO_DATA:1,END_PATH:2},e.prototype.average=function(t){var e={altitude:[],heading:[],speed:[]},n={altitude:3,heading:3,speed:3};for(var i in this._positionReports){var o=this._positionReports[i],r=.539957*o.position.distanceTo(t);3>=r&&(o.distance=r,isNaN(o.altitude)||(e.altitude.push(o),n>r&&(n.altitude=r)),isNaN(o.heading)||(e.heading.push(o),n>r&&(n.heading=r)),isNaN(o.speed)||(e.speed.push(o),n>r&&(n.speed=r)))}var a=-1,s=-1,l=-1;if(e.altitude.length>0){var h=0,c=0;for(var p in e.altitude){var o=e.altitude[p],u=Math.pow(n.altitude/o.distance,.5);h+=o.altitude*u,c+=u}a=h/c}if(e.heading.length>0){var _=0,f=0;for(var d in e.heading){var o=e.heading[d],u=Math.pow(n.heading/o.distance,.5),g=(90-o.heading+360)%360*Math.PI/180;_+=Math.cos(g)*u,f+=Math.sin(g)*u}s=(90-180*Math.atan2(f,_)/Math.PI+360)%360}if(e.speed.length>0){var y=0,T=0;for(var E in e.speed){var o=e.speed[E],u=Math.pow(n.speed/o.distance,.5);y+=o.speed*u,T+=u}l=y/T}return{altitude:a,heading:s-H.renderer().magVar()+0,speed:l}},e.prototype.project=function(t,i){var o=3,r=[];for(var a in this._positionReports){var s=this._positionReports[a],l=.539957*s.position.distanceTo(t);3>=l&&(s.distance=l,r.push(s),o>l&&(o=l))}{var h=0,c=0,p=0,u=0,_=0;Math.floor(.33*r.length)}for(var f in r){var d=r[f],g=d.aircraftPath[d.index+i];if(g){var y=g.position._lat*Math.PI/180,T=g.position._lon*Math.PI/180,E=Math.cos(y)*Math.cos(T),M=Math.cos(y)*Math.sin(T),x=Math.sin(y),v=Math.pow(o/d.distance,.5);h+=E*v,c+=M*v,p+=x*v,u+=v}else if(_++,_>=g)throw e.ERROR.END_PATH}var S=h/u,A=c/u,O=p/u,C=Math.atan2(A,S),m=Math.sqrt(Math.pow(S,2)+Math.pow(A,2)),R=Math.atan2(O,m);if(isNaN(R)||isNaN(C))throw e.ERROR.NO_DATA;return new n(180*R/Math.PI,180*C/Math.PI)},e.prototype.countInRange=function(t,e){var n=0;for(var i in this._positionReports){var o=.539957*this._positionReports[i].position.distanceTo(t);e>=o&&n++}return n},e.prototype.loadRecent=function(){for(var t=this,e=0;20>e;e+=20)$.get("proxy",{url:this._urlRoot+"/live/airport/KBOS/arrivals?;offset="+e},function(e){for(var i=e.match(/\/live\/flight\/\w+/g),o=1;o<i.length;o++)!function(e){$.get("proxy",{url:t._urlRoot+i[e]},function(e){var i=e.match(/data-target='(.+?)' style/),o=t._urlRoot+i[1]+"/tracklog";$.get("proxy",{url:o},function(e){var i=[],o=e.match(/<tr class="smallrow[12]{1}">[\s\S]+?<\/tr>/g),r=[];for(var a in o){var s=o[a],l=s.match(/<td align="center">(.+?)<\/td>[\s\S]+?<td align="center">(.+?)<\/td>[\s\S]+?<td align="center">(.+?)<\/td>[\s\S]+?<td align="center">(.+?)&deg;<\/td>[\s\S]+?<td align="left">(.+?)<\/td>[\s\S]+?<td align="right">(.*?)<\/td>[\s\S]+?<td align="right">(.*?)<\/td>[\s\S]+?<td align="right">(.*?)<\/td>[\s\S]+?<td align="right">(.*?)&nbsp;/),h=(l[1],parseFloat(l[2])),c=parseFloat(l[3]),p=parseInt(l[4]),u=(l[5],parseInt(l[6])),_=(parseInt(l[7]),parseInt(l[8].replace(",","")));r[a]={position:new n(h,c),heading:p,speed:u,altitude:_,aircraftPath:r,index:parseInt(a,10)},t._positionReports.push(r[a]),console.log("added")}t._aircraftPaths.push(r);for(var l=e.match(/"center">(.+?)</g),f=l.length/4,a=0;f>a;a++){var d=l[4*a+1].match(/>(.+?)</),g=l[4*a+2].match(/>(.+?)</);i[a]=[parseFloat(d[1]),parseFloat(g[1])]}t._paths.push(i)},"html")},"html")}(o)},"html")},e.prototype.loadRecent2=function(t,e,n){var i=this;$.get("proxy",{url:this._urlRoot+"/live/flight/SKV7384"},function(t){var e=t.match(/trackstring = ({.+});/),o=JSON.parse(e[1]),r=o.features[2].geometry.coordinates;for(var a in r){var s=r[a][0];r[a][0]=r[a][1],r[a][1]=s}i._paths.SKV73841=r,n(r)},"html")},e.prototype.renderPath=function(t,e){e.context().lineWidth=1.5,e.context().strokeStyle="rgba(255, 255, 0, .1)",e.context().beginPath();var n=e.gtoc(t[0][0],t[0][1]);e.context().moveTo(n.x,n.y);for(var i=1;i<t.length;i++){var o=e.gtoc(t[i][0],t[i][1]);e.context().lineTo(o.x,o.y)}e.context().stroke()},e.prototype.render=function(t){for(var e in this._paths)this.renderPath(this._paths[e],t)},n.prototype.distanceTo=function(t,e){"undefined"==typeof e&&(e=4);var n=this._radius,i=this._lat.toRad(),o=this._lon.toRad(),r=t._lat.toRad(),a=t._lon.toRad(),s=r-i,l=a-o,h=Math.sin(s/2)*Math.sin(s/2)+Math.cos(i)*Math.cos(r)*Math.sin(l/2)*Math.sin(l/2),c=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),p=n*c;return p.toPrecisionFixed(e)},n.prototype.bearingTo=function(t){var e=this._lat.toRad(),n=t._lat.toRad(),i=(t._lon-this._lon).toRad(),o=Math.sin(i)*Math.cos(n),r=Math.cos(e)*Math.sin(n)-Math.sin(e)*Math.cos(n)*Math.cos(i),a=Math.atan2(o,r);return(a.toDeg()+360)%360},n.prototype.finalBearingTo=function(t){var e=t._lat.toRad(),n=this._lat.toRad(),i=(this._lon-t._lon).toRad(),o=Math.sin(i)*Math.cos(n),r=Math.cos(e)*Math.sin(n)-Math.sin(e)*Math.cos(n)*Math.cos(i),a=Math.atan2(o,r);return(a.toDeg()+180)%360},n.prototype.midpointTo=function(t){lat1=this._lat.toRad(),lon1=this._lon.toRad(),lat2=t._lat.toRad();var e=(t._lon-this._lon).toRad(),i=Math.cos(lat2)*Math.cos(e),o=Math.cos(lat2)*Math.sin(e);return lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+i)*(Math.cos(lat1)+i)+o*o)),lon3=lon1+Math.atan2(o,Math.cos(lat1)+i),lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI,new n(lat3.toDeg(),lon3.toDeg())},n.prototype.destinationPoint=function(t,e){e="number"==typeof e?e:"string"==typeof e&&""!=e.trim()?+e:0/0,e/=this._radius,t=t.toRad();var i=this._lat.toRad(),o=this._lon.toRad(),r=Math.asin(Math.sin(i)*Math.cos(e)+Math.cos(i)*Math.sin(e)*Math.cos(t)),a=o+Math.atan2(Math.sin(t)*Math.sin(e)*Math.cos(i),Math.cos(e)-Math.sin(i)*Math.sin(r));return a=(a+3*Math.PI)%(2*Math.PI)-Math.PI,new n(r.toDeg(),a.toDeg())},n.intersection=function(t,e,i,o){return e="number"==typeof e?e:"string"==typeof e&&""!=trim(e)?+e:0/0,o="number"==typeof o?o:"string"==typeof o&&""!=trim(o)?+o:0/0,lat1=t._lat.toRad(),lon1=t._lon.toRad(),lat2=i._lat.toRad(),lon2=i._lon.toRad(),brng13=e.toRad(),brng23=o.toRad(),dLat=lat2-lat1,dLon=lon2-lon1,dist12=2*Math.asin(Math.sqrt(Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2))),0==dist12?null:(brngA=Math.acos((Math.sin(lat2)-Math.sin(lat1)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat1))),isNaN(brngA)&&(brngA=0),brngB=Math.acos((Math.sin(lat1)-Math.sin(lat2)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat2))),Math.sin(lon2-lon1)>0?(brng12=brngA,brng21=2*Math.PI-brngB):(brng12=2*Math.PI-brngA,brng21=brngB),alpha1=(brng13-brng12+Math.PI)%(2*Math.PI)-Math.PI,alpha2=(brng21-brng23+Math.PI)%(2*Math.PI)-Math.PI,0==Math.sin(alpha1)&&0==Math.sin(alpha2)?null:Math.sin(alpha1)*Math.sin(alpha2)<0?null:(alpha3=Math.acos(-Math.cos(alpha1)*Math.cos(alpha2)+Math.sin(alpha1)*Math.sin(alpha2)*Math.cos(dist12)),dist13=Math.atan2(Math.sin(dist12)*Math.sin(alpha1)*Math.sin(alpha2),Math.cos(alpha2)+Math.cos(alpha1)*Math.cos(alpha3)),lat3=Math.asin(Math.sin(lat1)*Math.cos(dist13)+Math.cos(lat1)*Math.sin(dist13)*Math.cos(brng13)),dLon13=Math.atan2(Math.sin(brng13)*Math.sin(dist13)*Math.cos(lat1),Math.cos(dist13)-Math.sin(lat1)*Math.sin(lat3)),lon3=lon1+dLon13,lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI,new n(lat3.toDeg(),lon3.toDeg())))},n.prototype.rhumbDistanceTo=function(t){var e=this._radius,n=this._lat.toRad(),i=t._lat.toRad(),o=(t._lat-this._lat).toRad(),r=Math.abs(t._lon-this._lon).toRad(),a=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(n/2+Math.PI/4)),s=isFinite(o/a)?o/a:Math.cos(n);Math.abs(r)>Math.PI&&(r=r>0?-(2*Math.PI-r):2*Math.PI+r);var l=Math.sqrt(o*o+s*s*r*r)*e;return l.toPrecisionFixed(4)},n.prototype.rhumbBearingTo=function(t){var e=this._lat.toRad(),n=t._lat.toRad(),i=(t._lon-this._lon).toRad(),o=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(e/2+Math.PI/4));Math.abs(i)>Math.PI&&(i=i>0?-(2*Math.PI-i):2*Math.PI+i);var r=Math.atan2(i,o);return(r.toDeg()+360)%360},n.prototype.rhumbDestinationPoint=function(t,e){var i=this._radius,o=parseFloat(e)/i,r=this._lat.toRad(),a=this._lon.toRad();t=t.toRad();var s=o*Math.cos(t);Math.abs(s)<1e-10&&(s=0);var l=r+s,h=Math.log(Math.tan(l/2+Math.PI/4)/Math.tan(r/2+Math.PI/4)),c=isFinite(s/h)?s/h:Math.cos(r),p=o*Math.sin(t)/c;return Math.abs(l)>Math.PI/2&&(l=l>0?Math.PI-l:-Math.PI-l),lon2=(a+p+3*Math.PI)%(2*Math.PI)-Math.PI,new n(l.toDeg(),lon2.toDeg())},n.prototype.rhumbMidpointTo=function(t){lat1=this._lat.toRad(),lon1=this._lon.toRad(),lat2=t._lat.toRad(),lon2=t._lon.toRad(),Math.abs(lon2-lon1)>Math.PI&&(lon1+=2*Math.PI);var e=(lat1+lat2)/2,i=Math.tan(Math.PI/4+lat1/2),o=Math.tan(Math.PI/4+lat2/2),r=Math.tan(Math.PI/4+e/2),a=((lon2-lon1)*Math.log(r)+lon1*Math.log(o)-lon2*Math.log(i))/Math.log(o/i);return isFinite(a)||(a=(lon1+lon2)/2),a=(a+3*Math.PI)%(2*Math.PI)-Math.PI,new n(e.toDeg(),a.toDeg())},n.prototype.lat=function(t,e){return"undefined"==typeof t?this._lat:Geo.toLat(this._lat,t,e)},n.prototype.lon=function(t,e){return"undefined"==typeof t?this._lon:Geo.toLon(this._lon,t,e)},n.prototype.toString=function(t,e){return"undefined"==typeof t&&(t="dms"),Geo.toLat(this._lat,t,e)+", "+Geo.toLon(this._lon,t,e)},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI}),"undefined"==typeof Number.prototype.toPrecisionFixed&&(Number.prototype.toPrecisionFixed=function(t){var e=this.toPrecision(t);return e=e.replace(/(.+)e\+(.+)/,function(t,e,n){for(e=e.replace(/\./,""),l=e.length-1;n-->l;)e+="0";return e}),e=e.replace(/(.+)e-(.+)/,function(t,e,n){for(e=e.replace(/\./,"");n-->1;)e="0"+e;return"0."+e})}),"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),"undefined"!=typeof module&&module.exports&&(module.exports=n),i.prototype={init:function(t){var e=this;e.glyphs={},e.properties={},e.parse(t)},parse:function(t){for(var e=this,n=t.split(/\n/),i=null,o=null,r=0,a=n.length;a>r;r++){var s=n[r];if(i)if("ENDCHAR"!=s)if(i.BITMAP)i.BITMAP.bits=4*s.length,i.BITMAP.push(parseInt(s,16));else{var l=s.split(" ");switch(l[0]){case"ENCODING":i.ENCODING=+l[1];break;case"SWIDTH":i.SWIDTH={x:+l[1],y:+l[2]};break;case"DWIDTH":i.DWIDTH={x:+l[1],y:+l[2]};break;case"BBX":i.BBw=+l[1],i.BBh=+l[2],i.BBox=+l[3],i.BBoy=+l[4];break;case"ATTRIBUTES":break;case"BITMAP":i.BITMAP=[]}}else e.glyphs[i.ENCODING]=i,i=null;else if(o)if("ENDPROPERTIES"!=s){var l=s.split(" ",2);o[l[0]]='"'==l[1][0]?l[1].substring(1,l[1].length-2):+l[1]}else e.properties=o,o=null;else{var l=s.split(" ");switch(l[0]){case"COMMENT":break;case"FONT":e.FONT=l[1];break;case"SIZE":e.SIZE={size:+l[1],xres:+l[2],yres:+l[3]};break;case"FONTBOUNDINGBOX":e.FONTBOUNDINGBOX={w:+l[1],h:+l[2],x:+l[3],y:+l[4]};break;case"STARTPROPERTIES":o={};break;case"CHARS":e.CHARS=+l[1];break;case"STARTCHAR":i={};case"ENDCHAR":}}}},drawChar:function(t,e,n,i,o){var r=this,a=r.glyphs[e]||r.glyphs[r.properties.DEFAULT_CHAR];if(o){var s=function(){};s.prototype=a,a=new s,a=o(a)}for(var l=(a.BBw,a.BITMAP),h=n+a.BBox-1,c=i-a.BBoy-a.BBh+1,p=0,u=l.length;u>p;p++)for(var _=l[p],f=l.bits,d=0;f>=0;f--,d++)_>>f&!0&&t.fillRect(h+d,c+p,1,1);return{x:n+a.DWIDTH.x,y:i+a.DWIDTH.y}},drawText:function(t,e,n,i,o){for(var r=this,a=0,s=e.length;s>a;a++){var l=e[a].charCodeAt(0),h=r.drawChar(t,l,n,i,o);n=h.x,i=h.y}return{x:n,y:i}},drawEdgeText:function(t,e,n,i){var o=this;o.drawText(t,e,n,i,function(t){var e=new Array(t.BITMAP.length+2);e.bits=t.BITMAP.bits+2;for(var n=-1,i=e.length;i>n;n++)e[n+1]=t.BITMAP[n]|t.BITMAP[n]>>1|t.BITMAP[n]>>2|t.BITMAP[n+1]|t.BITMAP[n+1]>>1|t.BITMAP[n+1]>>2|t.BITMAP[n-1]|t.BITMAP[n-1]>>1|t.BITMAP[n-1]>>2;return t.BITMAP=e,t.BBox+=-3,t.BBoy+=1,t})}},o.prototype.refresh=function(t){var e=this;this.fetch(t,function(t){e._overlays.push(t)})},o.prototype.fetch=function(t,e){var n="http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi",i={service:"WMS",request:"GetMap",version:"1.1.1",format:"PNG",width:t.scope().width,height:t.scope().height,SRS:"EPSG:4326",bbox:t.minLon()+","+t.minLat()+","+t.maxLon()+","+t.maxLat(),layers:"nexrad-n0q-conus"};$.get(n,i,function(t){e(t)},"jsonp")},o.prototype.render=function(t){if(this._overlays.length>0){t.context().save(),t.context().globalAlpha=.5;for(var e in this._contourGrid)for(var i in this._contourGrid[e]){var o=this._contourGrid[e][i];if(o.precip>0){var r=t.gtoc(o.lat,o.lon);t.context().beginPath(),t.context().moveTo(r.x-10,r.y-10),t.context().lineTo(r.x+10,r.y-10),t.context().lineTo(r.x+10,r.y+10),t.context().lineTo(r.x-10,r.y+10),t.context().fillStyle=o.precip<4?"rgb(25, 50, 50)":"rgb(70, 70, 35)",t.context().fill(),t.context().fillStyle="#fff",t.context().font="bold 14 px Arial",t.context().textAlign="center",t.context().textBaseline="middle",t.context().lineWidth=1,t.context().strokeStyle="rgb(100, 100, 100)";var a=o.lat*o.lon;o.precip%3==2?(t.context().beginPath(),t.context().moveTo(r.x,r.y),t.context().lineTo(r.x+2*Math.cos(a),r.y+2*Math.sin(a)),t.context().stroke()):o.precip%3==0&&(t.context().beginPath(),t.context().moveTo(r.x-20/3,r.y-20/3),t.context().lineTo(r.x-20/3+2*Math.cos(a),r.y-20/3+2*Math.sin(a)),t.context().stroke(),t.context().beginPath(),t.context().moveTo(r.x+20/3,r.y-20/3),t.context().lineTo(r.x+20/3+2*Math.cos(a),r.y-20/3+2*Math.sin(a)),t.context().stroke(),t.context().beginPath(),t.context().moveTo(r.x+20/3,r.y+20/3),t.context().lineTo(r.x+20/3+2*Math.cos(a),r.y+20/3+2*Math.sin(a)),t.context().stroke(),t.context().beginPath(),t.context().moveTo(r.x-20/3,r.y+20/3),t.context().lineTo(r.x-20/3+2*Math.cos(a),r.y+20/3+2*Math.sin(a)),t.context().stroke())}}t.context().restore()}else if(!this._weatherLoading){this._weatherLoading=!0;var s=this;$.get("wx/wx.php",{bbox:t.minLon()-.1*t.lonRange()+","+(t.minLat()-.1*t.latRange())+","+(t.maxLon()+.1*t.lonRange())+","+(t.maxLat()+.1*t.latRange())},function(){var e=new Image;e.src="wx/wx.gif",e.onload=function(){for(var i={data:s.imageToData(e)},o=new n(t.minLat()-.1*t.latRange(),t.minLon()-.1*t.lonRange()),r=new n(t.maxLat()+.1*t.latRange(),t.maxLon()+.1*t.lonRange()),a=.539957*o.distanceTo(new n(r._lat,o._lon)),l=(r._lat-o._lat)/a/1,h=0;h<r._lat-o._lat;h+=l){for(var c=[],p=[],u=.539957*new n(o._lat+h,o._lon).distanceTo(new n(o._lat+h,r._lon)),_=(r._lon-o._lon)/u/1,f=0;f<r._lon-o._lon;f+=_){var d=Math.floor(f/(r._lon-o._lon)*2048),g=e.height-Math.floor(h/(r._lat-o._lat)*2048),y=8192*g,T=y+4*d,E=(i.data[T+3],i.data[T]),M=i.data[T+1],x=i.data[T+2],v=0;x>E&&x>M&&Math.abs(E-M)<50?v=1:M>E&&x>E&&Math.abs(M-x)<100?v=2:M>E&&M>x&&Math.abs(E-x)<50?v=3:M>x&&Math.abs(E-M)<50?v=4:E>x&&M>50&&Math.abs(M-x)>50?v=5:E>x&&E>M&&Math.abs(M-x)<50&&(v=6),s._weatherMarks.push(o._lat+h),s._weatherMarks.push(o._lon+f),s._weatherMarks.push(v),s._weatherMarks.push(E),s._weatherMarks.push(M),s._weatherMarks.push(x),c.push({precip:v,lat:o._lat+h,lon:o._lon+f,red:E,green:M,blue:x}),p.push({precip:v,lat:o._lat+h,lon:o._lon+f,red:E,green:M,blue:x})}s._weatherGrid.push(c),s._contourGrid.push(p)}s._overlays.push(e)}})}},o.prototype.weatherDataToSystems=function(t,e){for(var i=weatherOverlay.imageToData(img),o=new n(e.minLat()-.1*e.latRange(),e.minLon()-.1*e.lonRange()),r=new n(e.maxLat()+.1*e.latRange(),e.maxLon()+.1*e.lonRange()),a=.539957*o.distanceTo(new n(r._lat,o._lon)),s=(r._lat-o._lat)/a,l=0;l<r._lat-o._lat;l+=s)for(var h=.539957*new n(o._lat+l,o._lon).distanceTo(new n(o._lat+l,r._lon)),c=(r._lon-o._lon)/h,p=0;p<r._lon-o._lon;p+=c){var u=Math.floor(p/(r._lon-o._lon)*2048),_=img.height-Math.floor(l/(r._lat-o._lat)*2048),f=8192*_,d=f+4*u,g=i.data[d+3];"255"==g&&(weatherOverlay._weatherMarks.push(o._lat+l),weatherOverlay._weatherMarks.push(o._lon+p),weatherOverlay._weatherMarks.push(i.data[d]),weatherOverlay._weatherMarks.push(i.data[d+1]),weatherOverlay._weatherMarks.push(i.data[d+2]))}weatherOverlay._overlays.push(img)},o.prototype.imageToData=function(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var n=e.getContext("2d");n.drawImage(t,0,0,t.width,t.height);var i=n.getImageData(0,0,t.width,t.height);return i.data};var n;"undefined"!=typeof module&&module.exports&&(n=require("../latlon.js")),r.SYNC_INTERVAL=3e5,r.prototype.enterSync=function(){this._syncing||(this._syncing=!0,this.sync(),setInterval(function(){this.sync()}.bind(this),r.SYNC_INTERVAL))},r.prototype.sync=function(){$.get("/api/metars/"+this.icao(),function(t){t&&(this._metar=t)}.bind(this))},r.prototype.numRunways=function(){return this._runways.length/2},r.prototype.addRunway=function(t){this._runways[t.id()]=t},r.prototype.runway=function(t){return this._runways[t]},r.prototype.runways=function(){return this._runways},r.prototype.runwayPairs=function(){var t={},e=[];for(var n in this._runways)if(!t[n]&&/^(\d{1,2})(L|C|R){0,1}$/.test(n)){var i=this.runwayPair(n);t[i[0].id()]=!0,t[i[1].id()]=!0,e.push(i)}return e},r.prototype.runwayPair=function(t){var e=t.match(/^(\d{1,2})(L|C|R){0,1}$/),n=e[2],i=parseInt(e[1],10),o="",r=(i+18)%36;switch(0===r&&(r=36),10>r&&(r="0"+r),n){case"L":o="R";break;case"R":o="L";break;case"C":o="C";break;default:o=""}var a=r+o;return[this.runway(t),this.runway(a)]},r.prototype.position=function(){return new n(this._lat,this._lon)},r.prototype.icao=function(){return this._icao},r.prototype.iata=function(){return this._iata},r.prototype.lat=function(){return this._lat},r.prototype.lon=function(){return this._lon},r.prototype.elevation=function(){return this._elevation},r.prototype.magVar=function(){return this._magVar},r.prototype.metar=function(){return this.enterSync(),this._metar},r.prototype.altimeter=function(){return this.metar()?this.metar().altimeter:"--.--"},r.prototype.windText=function(t){return this.metar()?t.pad(this.metar().wind.direction,3)+""+t.pad(this.metar().wind.speed,2):""},"undefined"!=typeof module&&module.exports&&(module.exports=r);var n;"undefined"!=typeof module&&module.exports&&(n=require("../latlon.js")),a.prototype.enableILS=function(){this._ILSCapable=!0},a.prototype.disableILS=function(){this._ILSCapable=!1},a.prototype.hasILS=function(){return this._ILSCapable},a.prototype.id=function(){return this._id},a.prototype.position=function(){return new n(this._lat,this._lon)},a.prototype.lat=function(){return this._lat},a.prototype.lon=function(){return this._lon},a.prototype.elevation=function(){return this._elevation},a.prototype.length=function(){return this._length},a.prototype.width=function(){return this._width},a.prototype.course=function(){return this._course},"undefined"!=typeof module&&module.exports&&(module.exports=a);var D,r,a,F=!1;"undefined"!=typeof module&&module.exports&&(D=require("./server/FacilitiesAPI.js"),r=require("./facilities/airport.js"),a=require("./facilities/runway.js"),F=!0),s.prototype.setPrimaryAirport=function(t){this._primaryAirport=t},s.prototype.primaryAirport=function(t,e){return this._primaryAirport?this.airport(this._primaryAirport,t,e):void t(null)},s.prototype.airports=function(){return this._airports},s.prototype.airport=function(t,e,n){var i=this._airports[t];if(i)return e(i);var o=function(t){if(t){this._airports[t.icao]=new r(t.icao,t.iata,t.lat,t.lon,t.elevation,t.magVar);for(var i in t.runways){var o=t.runways[i];this._airports[t.icao].addRunway(new a(o.id,o.lat,o.lon,o.elevation,o.length,o.width,o.course,o.ILSCapable))}return n||e(this._airports[t.icao])}e(null)}.bind(this);F?D.airport(t,o):$.get("/api/airports/"+t,o)},F&&(module.exports=s),h.prototype.setBrite=function(t){this._brite=t},h.prototype.render=function(t){if(this._display){t.context().strokeStyle=t.brite(this._brite),t.context().lineWidth=1;for(var e=Math.sqrt(Math.pow(t.scope().width/2,2)+Math.pow(t.scope().height/2,2)),n=0;360>n;n+=5){var i=(n-95)/180*Math.PI,o=(n-90)/180*Math.PI;t.context().beginPath(),t.context().arc(t.scope().width/2,t.scope().height/2,e,i,o),t.context().lineTo(t.scope().width/2,t.scope().height/2),t.context().stroke()}t.context().beginPath(),t.context().rect(this._notchLength,this._notchLength,t.scope().width-2*this._notchLength,t.scope().height-2*this._notchLength),t.context().fillStyle=t.background(),t.context().fill();for(var n=0;360>n;n+=10){var r=1/Math.abs(Math.cos(n/180*Math.PI))*(t.scope().height/2-(this._notchLength+15)),a=1/Math.abs(Math.sin(n/180*Math.PI))*(t.scope().width/2-(this._notchLength+15)),e=a>r?r:a,s=(n-90)/180*Math.PI,l=t.scope().width/2+Math.cos(s)*e,h=t.scope().height/2+Math.sin(s)*e;t.context().beginPath(),t.context().font="10px Oxygen Mono",t.context().textAlign="center",t.context().textBaseline="middle",t.context().fillStyle=t.brite(this._brite),t.context().fillText(t.pad(n,3,!0),l,h)}}},c.fromJSON=function(t){return new c(t.position,t.targetCode,t.identifier,t.name,t.frequency,null)},c.prototype.toJSON=function(){return{position:this.getPosition(),targetCode:this.getTargetCode(),identifier:this.getIdentifier(),name:this.getName(),frequency:this.getFrequency()}},c.prototype.getSocket=function(){return this._socket},c.prototype.getPosition=function(){return this._position},c.prototype.getTargetCode=function(){return this._targetCode},c.prototype.getIdentifier=function(){return this._identifier},c.prototype.getName=function(){return this._name},c.prototype.getFrequency=function(){return this._frequency},c.prototype.setTargetCode=function(t){this._targetCode=t},c.prototype.setIdentifier=function(t){this._identifier=t},c.prototype.setName=function(t){this._name=t},c.prototype.setFrequency=function(t){this._frequency=t},"undefined"!=typeof module&&module.exports&&(module.exports=c),p.prototype.conflicts=function(){var t=[];for(var e in this._conflictStates)this._conflictStates[e]!=this._conflictState.NONE&&t.push(e);return t},p.prototype.manageAlarm=function(){this._audibleConflicts>0?this._alarmSounding||(this._alarmSounding=!0,this._alarm.loop=!0,this._alarm.play()):this._alarmSounding&&(this._alarmSounding=!1,this._alarm.pause())},p.prototype.singleTargetInConflict=function(t){return this._conflicts[t.callsign()]?!0:!1},p.prototype.detect=function(t){for(var e=Object.keys(t),n=e.length,i=0;n>i;i++)for(var o=i+1;n>o;o++){var r=t[e[i]],a=t[e[o]];this.inConflict(r,a)?this.addConflict(r,a):this.removeConflict(r,a)}},p.prototype.addConflict=function(t,e){var n=this.targetsToIdentifier(t,e);this._conflictStates[n]&&this._conflictStates[n]!=this._conflictState.NONE||(this._conflictStates[n]=this._conflictState.ACTIVE,this._conflicts[t.callsign()]||(this._conflicts[t.callsign()]=0),this._conflicts[t.callsign()]++,this._conflicts[e.callsign()]||(this._conflicts[e.callsign()]=0),this._conflicts[e.callsign()]++,this._audibleConflicts++)},p.prototype.removeConflict=function(t,e){var n=this.targetsToIdentifier(t,e);this._conflictStates[n]==this._conflictState.ACTIVE?(this._conflictStates[n]=this._conflictState.NONE,this._conflicts[t.callsign()]--,this._conflicts[e.callsign()]--,this._audibleConflicts--):this._conflictStates[n]==this._conflictState.MUTED&&(this._conflictStates[n]=this._conflictState.NONE,this._conflicts[t.callsign()]--,this._conflicts[e.callsign()]--)},p.prototype.muteTarget=function(t,e){if(this._audibleConflicts>0)for(var n in e)this.muteConflict(t,e[n])},p.prototype.muteConflict=function(t,e){var n=this.targetsToIdentifier(t,e);this._conflictStates[n]==this._conflictState.ACTIVE&&(this._conflictStates[n]=this._conflictState.MUTED,this._audibleConflicts--,this.manageAlarm())},p.prototype.unmuteConflict=function(t,e){var n=this.targetsToIdentifier(t,e);this._conflictStates[n]==this._conflictState.MUTED&&(this._conflictStates[n]=this._conflictState.ACTIVE,this._audibleConflicts++,this.manageAlarm())},p.prototype.targetsToIdentifier=function(t,e){var n=[t.callsign(),e.callsign()];return n.sort(),n.join("*")},p.prototype.classifyMinima=function(t,e){var n={lateral:0,vertical:0};for(var i in this._separationMinima){var o=this._separationMinima[i];(o.lateral>n.lateral||o.vertical>o.vertical)&&(!o.anchor||o.anchor)&&(!o.minAltitude||t.altitude()>=o.minAltitude||e.altitude()>=o.minAltitude)&&(!o.maxAltitude||t.altitude()<=o.maxAltitude||e.altitude()<=o.maxAltitude)&&(n.lateral=Math.max(o.lateral,n.lateral),n.vertical=Math.max(o.vertical,n.vertical))
}return n},p.prototype.inConflict=function(t,e){var i=this.classifyMinima(t,e);if(Math.abs(t.altitude()-e.altitude())>=i.vertical)return!1;var o=new n(t.lat(),t.lon()),e=new n(e.lat(),e.lon());return.539957*o.distanceTo(e)>=i.lateral?!1:!0},u.ERROR={INVALID_RUNWAYS:1},u.prototype.enable=function(){this._enabled=!0},u.prototype.disable=function(){this._enabled=!1},u.prototype.isEnabled=function(){return this._enabled},u.prototype.toggle=function(){this._enabled=!this._enabled},u.prototype.ghostTargets=function(t,e){var n=t.getAllTargets();n.forEach(function(t){t.ghostState()!==M.GHOST_STATES.INHIBITED&&this.ghostTarget(t,e)}.bind(this))},u.prototype.select=function(t,e,n){var i=H.targetManager().getAllTargets();for(var o in i){var r=i[o];if(this.shouldGhostTarget(r,n)){var a=this.ghostPosition(r,n),s=n.gtoc(a._lat,a._lon),l=s.x-t,h=s.y-e,c=Math.sqrt(Math.pow(l,2)+Math.pow(h,2));if(15>c)return r}}return null},u.prototype.ghostTarget=function(t,e){this.shouldGhostTarget(t,e)&&this.renderGhost(t,this.ghostPosition(t,e),e)},u.prototype.shouldGhostTarget=function(t,e){return this._master&&(t.ghostState()===M.GHOST_STATES.FORCED||this.inMasterZone(t,e))},u.prototype.ghostPosition=function(t){var e=360-this._master.course()+this._master.position().bearingTo(t.position()),n=this._master.position().distanceTo(t.position());return this._slave.position().destinationPoint(this._slave.course()+e,n)},u.prototype.renderGhost=function(t,e,n){var i=n.gtoc(e._lat,e._lon);n.context().fillStyle="#ff0",n.context().strokeStyle="#ff0",n.context().beginPath(),n.context().font="bold 14px Oxygen Mono",n.context().textAlign="center",n.context().textBaseline="middle",n.context().fillText("0",i.x,i.y),n.context().beginPath(),n.context().moveTo(i.x-10,i.y),n.context().lineTo(i.x-40,i.y),n.context().lineWidth=1,n.context().stroke(),n.context().beginPath(),n.context().font="bold 14px Oxygen Mono",n.context().textAlign="right",n.context().textBaseline="middle";{var o=Math.floor(t.speed()/10);Math.floor(t.altitude()/100)}n.context().fillText(n.pad(o,2),i.x-45,i.y)},u.prototype.setMaster=function(t){this._master=t},u.prototype.setSlave=function(t){this._slave=t},u.prototype.master=function(){return this._master},u.prototype.slave=function(){return this._slave},u.prototype.airport=function(){return this._airport},u.prototype.inMasterZone=function(t,e){if(-1==t.course())return!1;var n=3280.84*t.position().distanceTo(this._master.position()),i=(t.altitude()-this._master.elevation(),Math.tan(3*Math.PI/180)*n);return t.altitude()<i+1e3&&this.angleBetween(t.course(),this._master.course())<90&&this.inMasterFunnel(t,e)?!0:!1},u.prototype.angleBetween=function(t,e){var n=Math.abs(t-e);return Math.min(n,360-n)},u.prototype.inMasterFunnel=function(t){var e=(360-this._master.course()+this._master.position().bearingTo(t.position()))%360,n=.539957*this._master.position().distanceTo(t.position());return e>=150&&210>=e&&30>=n},f.prototype.enable=function(){this._enabled=!0},f.prototype.disable=function(){this._enabled=!1},f.prototype.isEnabled=function(){return this._enabled},f.prototype.toggle=function(){this._enabled=!this._enabled},f.prototype.toggleCRDA=function(t){var e=this._CRDAs[t-1];e&&e.toggle()},f.prototype.select=function(t){var e=$(t.target).offset(),n=t.clientX-e.left,i=t.clientY-e.top,o=H.renderer();if(this.isEnabled())for(var r in this._CRDAs){var a=this._CRDAs[r];if(a.isEnabled()){var s=a.select(n,i,o);if(s)return s}}return null},f.prototype.ghostTargets=function(t,e){for(var n in this._CRDAs){var i=this._CRDAs[n];i.isEnabled()&&i.ghostTargets(t,e)}},f.prototype.addRemoveCRDA=function(t,e,n){var i=t.icao()+e+n;if(this._CRDAIdentifiers[i])for(var o in this._CRDAs){var r=this._CRDAs[o];if(r.airport().icao()===t.icao()&&r.master().id()===e&&r.slave().id()===n)return delete this._CRDAIdentifiers[i],this._CRDAs.splice(o,1)}else this._CRDAIdentifiers[i]=!0,this._CRDAs.push(new u(t,e,n))},f.prototype.CRDAs=function(){return this._CRDAs},d.prototype.id=function(){return this._id},d.prototype.name=function(){return this._name},d.prototype.enabled=function(){return this._enabled},d.prototype.toggle=function(){this._enabled=!this._enabled},d.prototype.setBrite=function(t){this._brite=t},d.prototype.loadFromFile=function(t,e,n){var i=this;$.get(t,function(t){i.addMapPath(t.split("\n"),e),n()})},d.prototype.addMapPath=function(t,e){for(var i in t){var o=t[i].trim().split(" ");if(o.length>=4){var r=[];if(r[0]=parseFloat(o[0]),isNaN(r[0])){for(var a in o)if(4>a){var s=o[a].split("."),l=parseInt(s[0].replace("N","+").replace("E","+").replace("S","-").replace("W","-")),h=parseInt(s[1].replace("N","+").replace("E","+").replace("S","-").replace("W","-")),c=parseInt(s[2].replace("N","+").replace("E","+").replace("S","-").replace("W","-")),p=parseInt(s[3].replace("N","+").replace("E","+").replace("S","-").replace("W","-"));r[a]=0>l?-1*(-1*l+h/60+parseFloat(c+"."+p)/3600):l+h/60+parseFloat(c+"."+p)/3600}}else for(var u=1;4>u;u++)r[u]=parseFloat(o[u]);e.setMinLat(Math.min(e.minLat(),r[0],r[2])),e.setMinLon(Math.min(e.minLon(),r[1],r[3])),e.setMaxLat(Math.max(e.maxLat(),r[0],r[2])),e.setMaxLon(Math.max(e.maxLon(),r[1],r[3])),this._path[i]=r}}var _=new n(e.minLat(),e.minLon()),f=_.midpointTo(new n(e.maxLat(),e.maxLon()));e.setMidLat(f._lat),e.setMidLon(f._lon)},d.prototype.render=function(t){if(this._enabled){t.context().lineWidth=1.5,t.context().strokeStyle=t.brite(this._brite);for(var e in this._path){var n=t.gtoc(this._path[e][0],this._path[e][1]),i=t.gtoc(this._path[e][2],this._path[e][3]);t.context().beginPath(),t.context().moveTo(n.x,n.y),t.context().lineTo(i.x,i.y),t.context().stroke()}}},g.prototype.setPreviewAreaMessage=function(t){this._previewMessage=t},g.prototype.clearPreviewAreaMessage=function(){this._previewMessage=""},g.prototype.lines=function(){return this._preview.length},g.prototype.formatError=function(){this._formatError=!0},g.prototype.previewSegments=function(){return this._preview},g.prototype.targetSelect=function(){if(1==this._preview.length){var t,e=this._scope._targetManager.getAllTargets();for(var n in e)if(e[n].callsign().lastIndexOf(this._preview[0])+this._preview[0].length==e[n].callsign().length){if(t)return;t=e[n]}t&&(this._preview[0]=t.callsign(),this.addPreviewChar(" "))}},g.prototype.processPreviewArea=function(){},g.prototype.clearPreview=function(){this._preview=[""],this._formatError=!1,B.MODE=B.MODES.NONE},g.prototype.keepFirstLine=function(){this._preview=this._preview.slice(0,1),this.addPreviewChar(" ")},g.prototype.addPreviewChar=function(t){" "==t?""!=this._preview[this._preview.length-1]&&this._preview.push(""):this._preview[this._preview.length-1]+=t,this._formatError=!1},g.prototype.removePreviewChar=function(){0==this._preview[this._preview.length-1].length?(this._preview.splice(this._preview.length-1),0==this._preview.length&&this.clearPreview()):this._preview[this._preview.length-1]=this._preview[this._preview.length-1].substr(0,this._preview[this._preview.length-1].length-1),this._formatError=!1},g.prototype.brite=function(t){return"red"===t?"rgb("+Math.round(255*this._brite/10)+", 0, 0)":"rgb(0, "+Math.round(255*this._brite/10)+", 0)"},g.prototype.line=function(t,e,n){return t.scope().height*e+20*n},g.prototype.renderPreviewArea=function(t){t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="top",t.context().fillStyle="#0c0",t.context().fillText(this._formatError?"FORMAT":this._previewMessage,75,this.line(t,.14,this._previewLine-1));for(var e=0;e<this._preview.length;e++)t.context().fillText(this._preview[e],75,this.line(t,.14,this._previewLine+e))},g.prototype.renderTime=function(t){t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="top",t.context().fillStyle=this.brite();var e=this._clock,n=""+e.getUTCHours(),i=""+e.getUTCMinutes(),o=""+e.getUTCSeconds(),r=(1==n.length?"0"+n:n)+(1==i.length?"0"+i:i)+"/"+(1==o.length?"0"+o:o);t.context().fillText(r,75,this.line(t,.14,0)),t.context().fillStyle=this.brite("green"),t.context().fillText("OK/OK/NA ",75,this.line(t,.14,1)),t.context().fillStyle=this.brite(),t.context().fillText(t.range()+"NM PTL: -.-",75,this.line(t,.14,2)),t.context().fillText("N99 999 U N99 999 A",75,this.line(t,.14,3));var a=H.facilityManager().airports(),s=Object.keys(a);s.forEach(function(e,n){var i=a[e];t.context().fillText(i.iata()+" "+i.altimeter()+" "+i.windText(t),75,this.line(t,.14,4+n))}.bind(this)),this._previewLine=6+s.length},g.prototype.renderControllers=function(t,e){t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="top",t.context().fillStyle=this.brite();var n=t.scope().width-200;e.forEach(function(e,i){t.context().fillText(e.getIdentifier()+" "+e.getName(),n,this.line(t,.2,i))}.bind(this))},g.prototype.renderLACAMCI=function(t){t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="top",t.context().fillStyle=this.brite();var e=t.scope().width-200;t.context().fillText("LA/CA/MCI",e,this.line(t,.8,0)),H.targetManager().conflicts().forEach(function(n,i){t.context().fillText(n+" CA",e,this.line(t,.8,1+i))}.bind(this))},g.prototype.renderTowerList=function(t,e){this._scope.facilityManager().primaryAirport(function(n){if(n){var i=e.concat(),o=0;i.sort(function(t,e){return t.position().distanceTo(n.position())-e.position().distanceTo(n.position())}),t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="top",t.context().fillStyle=this.brite(),t.context().fillText(n.iata()+" TOWER",75,this.line(t,.45,o++)),i.length>6&&t.context().fillText("MORE: 6/"+i.length,75,this.line(t,.45,o++)),i.splice(6);for(var r=0;r<i.length;r++){for(var a=i[r].callsign(),s=0;s<7-i[r].callsign().length;s++)a+=" ";t.context().fillText(a+" "+i[r].type(),75,this.line(t,.45,o+r))}}}.bind(this),!0)},g.prototype.renderCRDAStatus=function(t,e){t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="top",t.context().fillStyle=this.brite(),t.context().fillText("CRDA "+(e.isEnabled()?"STATUS":"OFF"),75,this.line(t,.8,0)),e.CRDAs().forEach(function(n,i){var o=i+1,r=e.isEnabled()&&n.isEnabled()?"*":" ";t.context().fillText(r+o+" "+n.airport().iata()+" "+n.master().id()+"/"+n.slave().id(),75,this.line(t,.8,o))}.bind(this))},y.ERROR={PATH_NOT_FOUND:1},y.prototype.setPath=function(t){this._paths[t.name()]=t},y.prototype.showPath=function(t){if("ALL"===t)return void(this._visiblePaths=Object.keys(this._paths));for(var e in this._visiblePaths)if(this._visiblePaths[e]===t)return;if(!this._paths[t])throw y.ERROR.PATH_NOT_FOUND;this._visiblePaths.push(t)},y.prototype.hidePath=function(t){if("ALL"===t)return void(this._visiblePaths=[]);for(var e in this._visiblePaths)if(this._visiblePaths[e]===t)return void this._visiblePaths.splice(e,1);throw y.ERROR.PATH_NOT_FOUND},y.prototype.render=function(t){for(var e in this._visiblePaths)new C(this._paths[this._visiblePaths[e]]).render(t)},T.prototype.addWaypoint=function(t,e){this._waypoints.push({name:t,position:e})},T.prototype.setName=function(t){this._name=t},T.prototype.name=function(){return this._name},T.prototype.waypoints=function(){return this._waypoints},E.prototype.setPosition=function(t){this._position=t},E.prototype.position=function(){return this._position},E.prototype.sweep=function(){},E.prototype.sync=function(t,e){var n=e.getTargetByCallsign(t.callsign);n?n.updateFromBlip(t):(n=new M,n.updateFromBlip(t),e.addTarget(n))},E.prototype.revSync=function(t,e,n){var i=e.getBlipByCallsign(t.callsign());i||n.noRadarReturn(t.callsign())},M.GHOST_STATES={ENABLED:1,FORCED:2,INHIBITED:3},M.CONFLICT_STATES={NONE:1,CONFLICTING:2,SUPPRESSED:3,INHIBITED:4},M.prototype.toggleConflictAlerts=function(){this._conflictState=this._conflictState===M.CONFLICT_STATES.INHIBITED?M.CONFLICT_STATES.NONE:M.CONFLICT_STATES.INHIBITED},M.prototype.setTargetsInConflict=function(t){if(this._conflictState!==M.CONFLICT_STATES.INHIBITED){var e={};this._conflictState=M.CONFLICT_STATES.NONE,t.forEach(function(t){var n=t.callsign();this._conflicts[n]?(e[n]=this._conflicts[n],e[n].isSuppressed?this._conflictState!==M.CONFLICT_STATES.CONFLICTING&&(this._conflictState=M.CONFLICT_STATES.SUPPRESSED):this._conflictState=M.CONFLICT_STATES.CONFLICTING):(this._conflictState=M.CONFLICT_STATES.CONFLICTING,e[n]={target:t,isSuppressed:!1})}.bind(this)),this._conflicts=e}else this._conflicts={};return this._conflictState},M.prototype.conflicts=function(){return this._conflicts},M.prototype.conflictState=function(){return this._conflictState},M.prototype.clearPostHandoff=function(){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this._otherController=null,this._controlState=this.isOwned()?this._controlStates.OWNED:this._controlStates.NORMAL,this.contract()},M.prototype.handoff=function(t){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this._otherController=t,this._controlState=this._controlStates.HANDOFF,this._handoffTimeout=setTimeout(function(){this._otherController=null,this._controlState=this._controlStates.OWNED}.bind(this),1e4)},M.prototype.acceptHandoff=function(){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this._otherController=null,this._controlState=this._controlStates.OWNED,this.setController(H.controller())},M.prototype.handoffAccepted=function(t){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this.expand(),this._controller=t,this._otherController=null,this._controlState=this._controlStates.POST_HANDOFF,H.sounds()&&new Audio("/sounds/HandoffAccepted.wav").play(),this._handoffTimeout=setTimeout(function(){this._controlState=this._controlStates.NORMAL,this.contract()}.bind(this),1e4)},M.prototype.refuseHandoff=function(){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this._otherController=null,this._controlState=this._controlStates.NORMAL,this.contract()},M.prototype.handoffRefused=function(){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this._otherController=null,this._controlState=this._controlStates.OWNED,H.sounds()&&new Audio("/sounds/Error.wav").play()},M.prototype.inboundHandoff=function(t){this._handoffTimeout&&(clearTimeout(this._handoffTimeout),delete this._handoffTimeout),this._otherController=t,this._controlState=this._controlStates.INBOUND_HANDOFF,this.expand(),H.sounds()&&new Audio("/sounds/HandoffRequest.wav").play(),this._handoffTimeout=setTimeout(function(){this._otherController=null,this._controlState=this._controlStates.NORMAL,this.contract()}.bind(this),1e4)},M.prototype.assignHeading=function(t){return t>=0&&360>=t?(socket.emit("TS.heading",{callsign:this.callsign(),heading:t}),!0):!1},M.prototype.assignAltitude=function(t){return t>=0&&99999>=t?(socket.emit("TS.altitude",{callsign:this.callsign(),altitude:t}),!0):!1},M.prototype.assignSpeed=function(t){return t>=0&&9999>=t?(socket.emit("TS.speed",{callsign:this.callsign(),speed:t}),!0):!1},M.prototype.otherController=function(){return this._otherController},M.prototype.updateFromBlip=function(t){this.update(t.callsign,t.mode,t.type,t.arrival,t.position,t.altitude,t.speed,t.squawk,t.controller),this._radarReturnTimeout&&clearTimeout(this._radarReturnTimeout),this._radarReturnTimeout=setTimeout(function(){this.noRadarReturn()}.bind(this),6e3)},M.prototype.update=function(t,e,n,i,o,r,a,s,l){this.setCallsign(t),this.setMode(e),this.setType(n),this.setArrival(i),this.setPosition(o),this.setAltitude(r),this.setSpeed(a),this.setSquawk(s);var h=this.controller();h&&h.getIdentifier()===l||this.setController(H.getControllerByIdentifier(l)),this.radarReturn()},M.prototype.setCallsign=function(t){this._callsign=t},M.prototype.setMode=function(t){this._mode=t},M.prototype.setType=function(t){this._type=t},M.prototype.setArrival=function(t){this._arrival=t},M.prototype.setPosition=function(t){t=new n(t._lat,t._lon),this.addHistory(t),this._position=t},M.prototype.setAltitude=function(t){this._altitude=t},M.prototype.setSpeed=function(t){this._speed=t},M.prototype.setSquawk=function(t){this._squawk=t},M.prototype.setController=function(t){this._controller=t,this._controlState!==this._controlStates.POST_HANDOFF&&(this.isOwned()?this.expand():this.contract())},M.prototype.addHistory=function(t){this._history.unshift(t),this._history.length>6&&(this._history.length=6)},M.prototype.callsign=function(){return this._callsign},M.prototype.mode=function(){return this._mode},M.prototype.type=function(){return this._type},M.prototype.arrival=function(){return this._arrival},M.prototype.position=function(){return this._position},M.prototype.altitude=function(){return this._altitude},M.prototype.speed=function(){return this._speed},M.prototype.squawk=function(){return this._squawk},M.prototype.controller=function(){return this._controller},M.prototype.history=function(){return this._history.slice(1)},M.prototype.course=function(){return this.history().length?this.history()[0].bearingTo(this.position()):-1},M.prototype.enableCone=function(t){this.disableJRing(),this._coneSize=t,this._isDisplayingCone=!0},M.prototype.disableCone=function(){this._isDisplayingCone=!1},M.prototype.isDisplayingCone=function(){return this._isDisplayingCone},M.prototype.enableJRing=function(t){this.disableCone(),this._jRingSize=t,this._isDisplayingJRing=!0},M.prototype.disableJRing=function(){this._isDisplayingJRing=!1},M.prototype.isDisplayingJRing=function(){return this._isDisplayingJRing},M.prototype.expand=function(){this._isExpanded=!0},M.prototype.contract=function(){this._isExpanded=!1},M.prototype.isExpanded=function(){return this._isExpanded},M.prototype.demoteGhosting=function(){switch(this._ghostState){case M.GHOST_STATES.ENABLED:this._ghostState=M.GHOST_STATES.INHIBITED;break;case M.GHOST_STATES.FORCED:this._ghostState=M.GHOST_STATES.ENABLED}},M.prototype.promoteGhosting=function(){switch(this._ghostState){case M.GHOST_STATES.INHIBITED:this._ghostState=M.GHOST_STATES.ENABLED;break;case M.GHOST_STATES.ENABLED:this._ghostState=M.GHOST_STATES.FORCED}},M.prototype.ghostState=function(){return this._ghostState},M.prototype.select=function(){if(this._isSelected=!0,this.isExpanded()||(this.expand(),setTimeout(function(){this.isOwned()||this.contract()}.bind(this),3e3)),this._controlState===this._controlStates.POST_HANDOFF&&this.clearPostHandoff(),this._conflictState===M.CONFLICT_STATES.CONFLICTING){this._conflictState=M.CONFLICT_STATES.SUPPRESSED;for(var t in this._conflicts)this._conflicts[t].isSuppressed=!0,this._conflicts[t].target.conflicts()[this.callsign()].isSuppressed=!0}},M.prototype.deselect=function(){this._isSelected=!1},M.prototype.isSelected=function(){return this._isSelected},M.prototype.inConflict=function(){this._isInConflict=!0},M.prototype.notInConflict=function(){this._isInConflict=!1},M.prototype.isInConflict=function(){return this._isInConflict},M.prototype.coast=function(){this._isCoasting=!0},M.prototype.uncoast=function(){this._isCoasting=!1},M.prototype.isCoasting=function(){return this._isCoasting},M.prototype.radarReturn=function(){this.uncoast(),this.cancelPurge()},M.prototype.noRadarReturn=function(){if(this.controller()&&!this.isCoasting()){this.coast();{setTimeout(function(){H.targetManager().purgeTarget(this)}.bind(this),3e4)}}return this.controller()?(this.isCoasting()&&this.coastPosition(),void(this._radarReturnTimeout=setTimeout(function(){this.noRadarReturn()}.bind(this),5e3))):H.targetManager().purgeTarget(this)},M.prototype.coastPosition=function(){var t=this.history();if(t.length>0){var e=t[0].distanceTo(this.position()),n=this.position().destinationPoint(this.course(),e);this.setPosition(n)}},M.prototype.awaitPurge=function(){this._isAwaitingPurge=!0},M.prototype.cancelPurge=function(){this._isAwaitingPurge=!1},M.prototype.isAwaitingPurge=function(){return this._isAwaitingPurge},M.prototype.isOwned=function(){return this.isControlled()&&this.controller()===H.controller()},M.prototype.isControlled=function(){return null!==this.controller()},M.prototype.isUndergoingHandoff=function(){return this._controlState===this._controlStates.HANDOFF},M.prototype.isUndergoingInboundHandoff=function(){return this._controlState===this._controlStates.INBOUND_HANDOFF},x.SEPARATION_MINIMA=[{anchor:null,radius:null,minAltitude:null,maxAltitude:17999,lateral:3,vertical:1e3},{anchor:null,radius:null,minAltitude:18e3,maxAltitude:null,lateral:5,vertical:1e3}],x.prototype.select=function(t,e,n){var i=this.getAllTargets(),o=null,r=0;for(r;r<i.length;r++){i[r].deselect();var a=n.gtoc(i[r].position()._lat,i[r].position()._lon),s=a.x-t,l=a.y-e,h=Math.sqrt(Math.pow(s,2)+Math.pow(l,2));if(15>h){o=i[r],o.select();break}}for(r+=1;r<i.length;r++)i[r].deselect();return o},x.prototype.getAllTargets=function(){return this._targets},x.prototype.getAllOwnedTargets=function(){return this.getAllTargets().filter(function(t){return null!==t.controller()&&t.controller()===H.controller()})},x.prototype.getTargetsByController=function(t){var e=[];return this._targets.forEach(function(n){n.controller()===t&&e.push(n)}),e},x.prototype.getTargetsByAirline=function(t){var e=[];return this._targets.forEach(function(n){n.callsign().substr(0,3)===t&&e.push(n)}),e},x.prototype.getOwnedTargetsByAirline=function(t){return this.getTargetsByAirline(t).filter(function(t){return null!==t.controller()&&t.controller()===H.controller()})},x.prototype.massHandoff=function(t,e){this.getTargetsByController(t).forEach(function(t){t.setController(e)})},x.prototype.getTargetByCallsign=function(t){for(var e=0;e<this._targets.length;e++)if(this._targets[e].callsign()===t)return this._targets[e];return null},x.prototype.manageAlarm=function(t){t&&H.sounds()?this._alarmSounding||(this._alarmSounding=!0,this._alarm.loop=!0,this._alarm.play()):this._alarmSounding&&(this._alarmSounding=!1,this._alarm.pause())},x.prototype.classifyMinima=function(t,e){var n={lateral:0,vertical:0};for(var i in x.SEPARATION_MINIMA){var o=x.SEPARATION_MINIMA[i];(o.lateral>n.lateral||o.vertical>o.vertical)&&(!o.anchor||o.anchor)&&(!o.minAltitude||t.altitude()>=o.minAltitude||e.altitude()>=o.minAltitude)&&(!o.maxAltitude||t.altitude()<=o.maxAltitude||e.altitude()<=o.maxAltitude)&&(n.lateral=Math.max(o.lateral,n.lateral),n.vertical=Math.max(o.vertical,n.vertical))}return n},x.prototype.isInConflict=function(t,e){var n=this.classifyMinima(t,e);return Math.abs(t.altitude()-e.altitude())>=n.vertical?!1:.539957*t.position().distanceTo(e.position())>=n.lateral?!1:!0},x.prototype.detectConflicts=function(){var t=this.getAllTargets(),e=Array(t.length),n=!1;this._conflicts=[];for(var i=0;i<t.length;i++){var o=t[i];if(o.conflictState()!==M.CONFLICT_STATES.INHIBITED)for(var r=i+1;r<t.length;r++){var a=t[r];a.conflictState()!==M.CONFLICT_STATES.INHIBITED&&this.isInConflict(o,a)&&(this._conflicts.push(o.callsign()<a.callsign()?o.callsign()+"*"+a.callsign():a.callsign()+"*"+o.callsign()),e[i]?e[i].push(a):e[i]=[a],e[r]?e[r].push(o):e[r]=[o])}}this._conflicts.sort(),t.forEach(function(t,i){e[i]||(e[i]=[]),t.setTargetsInConflict(e[i])===M.CONFLICT_STATES.CONFLICTING&&(n=!0)}),this.manageAlarm(n)},x.prototype.conflicts=function(){return this._conflicts},x.prototype.purgeTarget=function(t){for(var e=0;e<this._targets.length;e++){var n=this._targets[e];if(n===t)return void this._targets.splice(e,1)}},x.prototype.purgeTargets=function(){for(var t=!1,e=0;e<this._targets.length;e++){var n=this._targets[e];n.isAwaitingPurge()&&(t=!0,this._targets.splice(e,1),e--)}t&&this.updateCallsigns()},x.prototype.noRadarReturn=function(t){for(var e=0;e<this._targets.length;e++){var n=this._targets[e];if(n.callsign()===t)return n.noRadarReturn(),void(n.isAwaitingPurge()&&this._targets.splice(e,1))}},x.prototype.addTarget=function(t){this._targets.push(t),this.updateCallsigns()},x.prototype.reset=function(){this._targets=[],this.updateCallsigns()},x.prototype.updateCallsigns=_.throttle(function(){var t={};this._targets.forEach(function(e){t[e.callsign().substr(0,3)]=!0}),$.get("/api/callsigns",{airlines:Object.keys(t)},function(t){var e={};for(var n in t)e[t[n].toUpperCase()]=n.toUpperCase();this._airlines=e,this._callsigns=t}.bind(this))},1e3,{leading:!1}),x.prototype.callsigns=function(){return Object.keys(this._airlines)},x.prototype.getAirlineByCallsign=function(t){return this._airlines[t]},x.prototype.getCallsignByAirline=function(t){return this._callsigns[t]},x.prototype.render=function(t){var e=t.elapsed(),n=this.getAllTargets(),i=[];this.detectConflicts();for(var o in n)t.inBounds(n[o].position()._lat,n[o].position()._lon)&&i.push(new O(n[o]));for(var r in i)i[r].renderHistory(t);for(var a in i)i[a].renderExtras(t);for(var s in i)i[s].renderTarget(t);for(var l in i)i[l].renderPosition(t,e);for(var h in i)i[h].renderDataBlock(t,e)},v.prototype.radar=function(){return this._radar},v.prototype.setControllers=function(t){t.sort(function(t,e){return t.getIdentifier()<e.getIdentifier()?-1:1}.bind(this)),this._controller?(this._controllers=[this._controller],t.forEach(function(t){t.getIdentifier()!==this._controller.getIdentifier()&&this._controllers.push(t)}.bind(this))):this._controllers=t},v.prototype.getControllerByIdentifier=function(t){for(var e in this._controllers)if(this._controllers[e].getIdentifier()===t)return this._controllers[e];return null},v.prototype.controllers=function(){return this._controllers},v.prototype.setControllerPosition=function(t,e){this._controller?this._socket.emit("ATC.deleteController",function(){this._targetManager.massHandoff(this._controller,null),this.setController(null),this.setControllerPosition(t,e)}.bind(this)):this._socket.emit("ATC.addController",{position:t},function(t){this.setController(new c(t.position,t.targetCode,t.identifier,t.name,"199.98",null)),e&&e()}.bind(this))},v.prototype.sounds=function(){return this._sounds},v.prototype.setController=function(t){this._controller=t},v.prototype.controller=function(){return this._controller},v.prototype.facilityManager=function(){return this._facilityManager},v.prototype.CRDAManager=function(){return this._CRDAManager},v.prototype.turnOn=function(){if(!this._isOn){this._isOn=!0;var t=_.throttle(this.render.bind(this),200);socket.on("blip",function(e){this._radar.sync(e,this._targetManager),t()}.bind(this))}},v.prototype.turnOff=function(){this._isOn&&(this._isOn=!1,clearInterval(this._radarManager),this._targetManager.reset())},v.prototype.targetManager=function(){return this._targetManager},v.prototype.pathManager=function(){return this._pathManager},v.prototype.select=function(t){var e=$(t.target).offset(),n=t.clientX-e.left,i=t.clientY-e.top;return this._targetManager.select(n,i,this._renderer)},v.prototype.selectPosition=function(t){var e=$(t.target).offset(),n=t.clientX-e.left,i=t.clientY-e.top,o=this._targetManager.select(n,i,this._renderer);if(o)return o.position();var r=this._renderer.ctop(n,i);return r},v.prototype.measureHeadingAndDistance=function(t){if(this._measureDistanceStartPosition){var e=this.selectPosition(t),n=Math.round(this._measureDistanceStartPosition.bearingTo(e)-this._renderer.magVar())%360,i=.539957*this._measureDistanceStartPosition.distanceTo(e);return this._measureDistanceStartPosition=null,{heading:this._renderer.pad(n,3,!0),distance:i.toFixed(2)}}return this._measureDistanceStartPosition=this.selectPosition(t),null},v.prototype.addRenderPoint=function(t){this._renderPoints.push(t)},v.prototype.clearRenderPoints=function(){this._renderPoints=[]},v.prototype.addRenderPath=function(t){this._renderPaths.push(t)},v.prototype.clearRenderPaths=function(){this._renderPaths=[]},v.prototype.bind=function(t){this._renderer.bind(t)},v.prototype.addAirport=function(t){this._airports[t.icao()]=t},v.prototype.airport=function(t){return this._airports[t]},v.prototype.addMap=function(t,e,n,i){this._maps[t]=new d(t,e,n,this._renderer,i)},v.prototype.enableSmartMap=function(){this._maps.SMART=new S("SMART","",this)},v.prototype.setSituation=function(){},v.prototype.maps=function(){return this._maps},v.prototype.map=function(t){return this._maps[t]},v.prototype.situation=function(){},v.prototype.renderer=function(){return this._renderer},v.prototype.compass=function(){return this._compass},v.prototype.textOverlay=function(){return this._textOverlay},v.prototype.fit=function(){this._renderer.scope().width=$(window).width()-($(".situation-controls").is(":visible")?250:0),this._renderer.scope().height=$(window).height()-($(".scope-settings").is(":visible")?54:0)},v.prototype.renderBackground=function(){this._renderer.context().fillStyle=this._renderer.background(),this._renderer.context().strokeStyle=this._renderer.brite(this._compass._brite),this._renderer.context().lineWidth=1,this._renderer.context().fillRect(0,0,this._renderer.scope().width,this._renderer.scope().height),this._renderer.context().strokeRect(0,0,this._renderer.scope().width,this._renderer.scope().height)},v.prototype.renderRangeRings=function(){this._renderer.context().moveTo()},v.prototype.renderOverlays=function(){this._textOverlay.renderTime(this._renderer,this._airports),this._textOverlay.renderTowerList(this._renderer,this.targetManager().getAllTargets()),this._textOverlay.renderLACAMCI(this._renderer),this._textOverlay.renderCRDAStatus(this._renderer,this.CRDAManager()),this._textOverlay.renderPreviewArea(this._renderer),this._textOverlay.renderControllers(this._renderer,this._controllers)},v.prototype.renderRenderPoints=function(){if(this._renderPoints.length){var t=((new Date).getTime()-this._renderPointsBlinker)%1e3<667?"#0c0":"#060";for(var e in this._renderPoints){var n=this._renderer.gtoc(this._renderPoints[e]._lat,this._renderPoints[e]._lon);this._renderer.context().beginPath(),this._renderer.context().moveTo(n.x-3,n.y-3),this._renderer.context().lineTo(n.x+3,n.y-3),this._renderer.context().lineTo(n.x+3,n.y+3),this._renderer.context().lineTo(n.x-3,n.y+3),this._renderer.context().fillStyle=t,this._renderer.context().fill()}}},v.prototype.render=function(){this.fit(),this.renderBackground(),this._compass.render(this._renderer);for(var t in this._maps)this._maps[t].render(this._renderer);this._flow.render(this._renderer),this._pathManager.render(this._renderer),this.renderRenderPoints(),this.renderOverlays(),this._CRDAManager.isEnabled()&&this._CRDAManager.ghostTargets(this._targetManager,this._renderer),this._targetManager.render(this._renderer)},S.prototype.id=function(){return this._id},S.prototype.name=function(){return this._name},S.prototype.enabled=function(){return this._enabled},S.prototype.toggle=function(){this._enabled=!this._enabled},S.prototype.setBrite=function(t){this._brite=t},S.prototype.configure=function(){this._scope.facilityManager().primaryAirport(function(t){this._scope.renderer().setMagVar(t.magVar()),this._primaryAirport=t,this.generatePrimaryAirport(),this.generateCoastline(),this.generateNavaids(),this._enabled=!0}.bind(this))},S.prototype.generatePrimaryAirport=function(){this.generateRunwayPairs(this._primaryAirport),this.generateLocalizers(this._primaryAirport)},S.prototype.generateRunwayPairs=function(t){var e=t.runwayPairs();for(var n in e)this.generateRunwayPair(e[n])},S.prototype.generateRunwayPair=function(t){this.layer([t[0].position(),t[1].position()],"RUNWAY")},S.prototype.generateLocalizers=function(t){var e=t.runways();for(var n in e){var i=e[n];i.hasILS()&&this.generateLocalizer(i)}},S.prototype.generateLocalizer=function(t){for(var e=t.position(),n=(t.course()+180)%360,i=1;25>i;i+=2){var o=e.destinationPoint(n,1.852*i),r=e.destinationPoint(n,1.852*(i+1));this.layer([o,r],"LOCALIZER")}for(var a=5;15>=a;a+=5){var s=e.destinationPoint(n,1.852*a),l=s.destinationPoint(n-90,1.1112),h=s.destinationPoint(n+90,1.1112);
this.layer([l,h],"LOCALIZER")}},S.prototype.generateCoastline=function(){$.get("/api/coastline",{lat:this._primaryAirport.lat(),lon:this._primaryAirport.lon(),radius:60},function(t){for(var e in t){var i=t[e];this.layer([new n(i[0],i[1]),new n(i[2],i[3])],"COASTLINE")}}.bind(this))},S.prototype.generateFixes=function(){$.get("/api/fixes",{lat:this._primaryAirport.lat(),lon:this._primaryAirport.lon(),radius:60},function(t){for(var e in t){var i=t[e],o=new n(i.lat,i.lon);this.layer([o,o.destinationPoint(360*Math.random(),1)],"FIX")}}.bind(this))},S.prototype.generateNavaids=function(){$.get("/api/navaids",{lat:this._primaryAirport.lat(),lon:this._primaryAirport.lon(),radius:60},function(t){for(var e in t){for(var i=t[e],o=new n(i.lat,i.lon),r=[],a=0;12>a;a++)r.push(o.destinationPoint(30*a,.7));r.push(r[0]),this.layer(r,"NAVAID")}}.bind(this))},S.prototype.layer=function(t,e){var i=this._scope.renderer(),o=this._yields[e];for(var r in o){var a=this._pathsByType[o[r]];for(var s in a){var l=a[s];for(var h in l){var c=l[h];for(var p in t){var u=t[p];if(.539957*u.distanceTo(c)<.5)return}}}}this._pathsByType[e].push(t),this._paths.push(t),i.setMinLat(Math.min(i.minLat(),t[0]._lat,t[1]._lat)),i.setMinLon(Math.min(i.minLon(),t[0]._lon,t[1]._lon)),i.setMaxLat(Math.max(i.maxLat(),t[0]._lat,t[1]._lat)),i.setMaxLon(Math.max(i.maxLon(),t[0]._lon,t[1]._lon));var _=new n(i.minLat(),i.minLon()),f=_.midpointTo(new n(i.maxLat(),i.maxLon()));i.setMidLat(f._lat),i.setMidLon(f._lon)},S.prototype.render=function(t){if(this._enabled){t.context().lineWidth=1.5,t.context().strokeStyle=t.brite(this._brite);for(var e in this._paths){var n=this._paths[e],i=t.gtoc(n[0]._lat,n[0]._lon);t.context().beginPath(),t.context().moveTo(i.x,i.y);for(var o=1;o<n.length;o++){var r=t.gtoc(n[o]._lat,n[o]._lon);t.context().lineTo(r.x,r.y)}t.context().stroke()}}},A.prototype.bind=function(t){this._scope=$(t)[0],this._context=this._scope.getContext("2d")},A.prototype.scope=function(){return this._scope},A.prototype.context=function(){return this._context},A.prototype.inBounds=function(t,e){var n=this.gtoc(t,e);return n.x>=0&&n.y>=0&&n.x<=this._scope.width&&n.y<=this._scope.height},A.prototype.elapsed=function(){return(new Date).getTime()-this._created},A.prototype.enableTargetHistory=function(){this._targetHistory=!0},A.prototype.disableTargetHistory=function(){this._targetHistory=!1},A.prototype.targetHistory=function(){return this._targetHistory},A.prototype.setMinLat=function(t){this._minLat=t},A.prototype.setMinLon=function(t){this._minLon=t},A.prototype.setMidLat=function(t){this._midLat=t},A.prototype.setMidLon=function(t){this._midLon=t},A.prototype.setMaxLat=function(t){this._maxLat=t},A.prototype.setMaxLon=function(t){this._maxLon=t},A.prototype.minLat=function(){return this._minLat},A.prototype.minLon=function(){return this._minLon},A.prototype.midLat=function(){return this._midLat},A.prototype.midLon=function(){return this._midLon},A.prototype.maxLat=function(){return this._maxLat},A.prototype.maxLon=function(){return this._maxLon},A.prototype.scope=function(){return this._scope},A.prototype.context=function(){return this._context},A.prototype.background=function(){return this._background},A.prototype.radarCenter=function(){var t,e;return this._radarCenter.lat?(t=this._radarCenter.lat,e=this._radarCenter.lon):(t=this._midLat,e=this._midLon),this.gtoc(t,e)},A.prototype.radarCenterPosition=function(){var t,e;return this._radarCenter.lat?(t=this._radarCenter.lat,e=this._radarCenter.lon):(t=this._midLat,e=this._midLon),new n(t,e)},A.prototype.setRadarCenter=function(t){this._radarCenter={lat:t._lat,lon:t._lon}},A.prototype.magVar=function(){return this._magVar},A.prototype.setMagVar=function(t){this._magVar=t},A.prototype.globalScale=function(){return this._globalScale},A.prototype.setGlobalScale=function(t){this._globalScale=t},A.prototype.lastMousePosition=function(){return this._translation.lastMousePosition},A.prototype.setLastMousePosition=function(t){this._translation.lastMousePosition=t},A.prototype.translationOffset=function(){return this._translation.offset},A.prototype.setTranslationOffset=function(t){this._translation.offset=t},A.prototype.mouseDown=function(){return this._mouseDown},A.prototype.setMouseDown=function(t){t&&!this._mouseDown&&(this._dragging=!1),this._mouseDown=t},A.prototype.dragging=function(){this._dragging=!0},A.prototype.wasDragging=function(){return this._dragging},A.prototype.latRange=function(){return this._maxLat-this._minLat},A.prototype.lonRange=function(){return this._maxLon-this._minLon},A.prototype.scaledLatRange=function(t){return this.latRange()*(1/Math.cos(t/180*Math.PI))},A.prototype.multiplier=function(t){return this._scope.height/this.scaledLatRange(t)},A.prototype.scaleX=function(t,e){return this.gtoc(t,e).x},A.prototype.scaleY=function(t,e){return this.gtoc(t,e).y},A.prototype.brite=function(t){return"#"+111*t},A.prototype.rotate=function(t,e,n,i,o){var r=t-n,a=e-i;o*=-1;var s=Math.cos(o)*r-Math.sin(o)*a,l=Math.sin(o)*r+Math.cos(o)*a,h=s+n,c=l+i;return{x:h,y:c}},A.staticRotate=function(t,e,n,i,o){var r=t-n,a=e-i;o*=-1;var s=Math.cos(o)*r-Math.sin(o)*a,l=Math.sin(o)*r+Math.cos(o)*a,h=s+n,c=l+i;return{x:h,y:c}},A.prototype.gtoc=function(t,e){var n=this.multiplier(t),i=n*(e-this._minLon)+this._scope.width/2-this.lonRange()*n/2,o=this._scope.height-n*(1/Math.cos(t/180*Math.PI))*(t-this._minLat),r=i-this._scope.width/2,a=this._scope.height/2-o,s=this._magVar/180*Math.PI,l=(Math.cos(s)*r-Math.sin(s)*a)*this._globalScale+this._translation.offset.x*this._globalScale,h=(Math.sin(s)*r+Math.cos(s)*a)*this._globalScale+this._translation.offset.y*this._globalScale,c=l+this._scope.width/2,p=this._scope.height/2-h;return{x:c,y:p}},A.prototype.ctop=function(t,e){var i=this._scope.height/2-e,o=t-this._scope.width/2,r=(i-this._translation.offset.y*this._globalScale)/this._globalScale,a=(o-this._translation.offset.x*this._globalScale)/this._globalScale,s=this._magVar/180*Math.PI,l=(Math.cos(s)*r-Math.sin(s)*a)/(Math.pow(Math.sin(s),2)+Math.pow(Math.cos(s),2)),h=(r-Math.cos(s)*l)/Math.sin(s),c=this._scope.height/2-l,p=h+this._scope.width/2,u=(this.latRange()*(this._scope.height-c)+this._scope.height*this._minLat)/this._scope.height,_=this._scope.height*Math.cos(u/180*Math.PI)/this.latRange(),f=(2*p-this._scope.width+2*this._minLon*_+this.lonRange()*_)/(2*_);return new n(u,f)},A.prototype.distanceToPixels=function(t,e,n){var i=this.gtoc(t._lat,t._lon),o=t.destinationPoint(e,n/.539957),r=this.gtoc(o._lat,o._lon);return Math.sqrt(Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2))},A.prototype.range=function(){var t=this.distanceToPixels(new n(this._midLat,this._midLon),0,1);return Math.round(this._scope.height/t)},A.prototype.setPreset=function(t){this._presets[t]={scale:this._globalScale,translation:{x:this._translation.offset.x,y:this._translation.offset.y}}},A.prototype.selectPreset=function(t){var e=this._presets[t];e&&(this._globalScale=e.scale,this._translation.offset=e.translation)},A.prototype.scale=function(t){return t/this._globalScale},A.prototype.adjustForMagVar=function(){this._context.translate(this._scope.width/2,this._scope.height/2),this._context.rotate(-this._magVar/180*Math.PI),this._context.translate(-this._scope.width/2,-this._scope.height/2)},A.prototype.pad=function(t,e,n){i=0==t&&n?360:t;var i="00000"+i;return i.substr(i.length-e)},A.prototype.angleBetweenHeadings=function(t,e){var n=Math.abs(t-e);return Math.min(n,360-n)},A.prototype.angleBetween=function(t,e,n,i){return Math.atan2(e-i,n-t)},O.DIRECTION={N:0*Math.PI,NE:.25*Math.PI,E:.5*Math.PI,SE:.75*Math.PI,S:1*Math.PI,SW:1.25*Math.PI,W:1.5*Math.PI,NW:1.75*Math.PI},O.setLeaderLength=function(t){console.log(t),O.LEADER_LENGTH=Math.min(Math.max(parseInt(t,10),0),7),console.log(O.LEADER_LENGTH)},O.setLeaderDirection=function(t){t in O.DIRECTION&&(O.LEADER_DIRECTION=O.DIRECTION[t])},O.getLeaderDirectionString=function(){for(var t in O.DIRECTION)if(O.DIRECTION[t]===O.LEADER_DIRECTION)return t},O.LEADER_LENGTH=3,O.LEADER_DIRECTION=O.DIRECTION.N,O.LEADER_TIP_OFFSET={length:O.LEADER_LENGTH,direction:O.LEADER_DIRECTION},O.getLeaderTipOffset=function(){return A.staticRotate(0,15*O.LEADER_LENGTH,0,0,O.LEADER_DIRECTION)},O.prototype.renderDataBlockColor=function(t){return this._target._controlState===this._target._controlStates.INBOUND_HANDOFF||this._target._controlState===this._target._controlStates.POST_HANDOFF?500>t%1e3?"#fff":"#bbb":this._target._controlState===this._target._controlStates.POST_HANDOFF?500>t%1e3?"#0c0":"#080":this._target.isOwned()?"#fff":"#0c0"},O.prototype.renderCone=function(t){if(-1!=this._target.course()&&this._target.isDisplayingCone()){var e=this._target.course()-t.magVar(),n=t.distanceToPixels(this._target.position(),this._target.course(),this._target._coneSize),i=n/12,o=t.gtoc(this._target.position()._lat,this._target.position()._lon),r=-e*Math.PI/180,a=t.rotate(-i/2,-n,0,0,r),s=t.rotate(i/2,-n,0,0,r),l=t.rotate(0,-n/2,0,0,r);t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="center",t.context().textBaseline="middle",t.context().fillStyle="#369",t.context().fillText(""+this._target._coneSize,o.x+l.x,o.y+l.y);var h=t.context().measureText(""+this._target._coneSize).width/2,c=6,p=Math.min(o.x+a.x,o.x+s.x,o.x),u=Math.max(o.x+a.x,o.x+s.x,o.x),_=Math.min(o.y+a.y,o.y+s.y,o.y),f=Math.max(o.y+a.y,o.y+s.y,o.y);t.context().save(),t.context().beginPath(),t.context().moveTo(p,_),t.context().lineTo(o.x+l.x,_),t.context().lineTo(o.x+l.x,o.y+l.y-c-4),t.context().lineTo(o.x+l.x-h-4,o.y+l.y-c-4),t.context().lineTo(o.x+l.x-h-4,o.y+l.y+c+4),t.context().lineTo(o.x+l.x+h+4,o.y+l.y+c+4),t.context().lineTo(o.x+l.x+h+4,o.y+l.y-c-4),t.context().lineTo(o.x+l.x,o.y+l.y-c-4),t.context().lineTo(o.x+l.x,_),t.context().lineTo(u,_),t.context().lineTo(u,f),t.context().lineTo(p,f),t.context().lineTo(p,_),t.context().clip(),t.context().strokeStyle="#369",t.context().lineWidth=1,t.context().beginPath(),t.context().moveTo(o.x,o.y),t.context().lineTo(o.x+a.x,o.y+a.y),t.context().lineTo(o.x+s.x,o.y+s.y),t.context().lineTo(o.x,o.y),t.context().stroke(),t.context().restore()}},O.prototype.renderJRing=function(t){if(this._target.isDisplayingJRing()){var e=t.gtoc(this._target.position()._lat,this._target.position()._lon),n=t.distanceToPixels(this._target.position(),this._target.course(),this._target._jRingSize);t.context().strokeStyle="#369",t.context().lineWidth=1,t.context().beginPath(),t.context().arc(e.x,e.y,n,0,2*Math.PI),t.context().stroke(),t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="center",t.context().textBaseline="bottom",t.context().fillStyle="#369",t.context().fillText(""+this._target._jRingSize,e.x,e.y+n)}},O.prototype.renderExtras=function(t){this.renderJRing(t),this.renderCone(t)},O.prototype.renderHistory=function(t){if(t.targetHistory()){t.context().fillStyle="#26c";for(var e in this._target.history()){var n=t.gtoc(this._target.history()[e]._lat,this._target.history()[e]._lon);t.context().beginPath(),t.context().arc(n.x,n.y,2.5-Math.floor((e-1)/4),0,2*Math.PI),t.context().globalAlpha=.5-(e-1)/10,t.context().fill()}t.context().globalAlpha=1}},O.prototype.renderTarget=function(t){if(!this._target.isCoasting()){var e=.539957*t.radarCenterPosition().distanceTo(this._target.position()),n=(Math.min(Math.max(e,5),40)-5)/35*2.5+.5,i=t.gtoc(this._target.position()._lat,this._target.position()._lon),o=t.radarCenter(),r=t.angleBetween(i.x,i.y,o.x,o.y)+Math.PI/2,a=t.distanceToPixels(this._target.position(),0,.01),s=t.distanceToPixels(this._target.position(),0,.25),l=Math.max(n*s,4.5),h=Math.max(s,3),c=t.rotate(2*-l,0,0,0,r),p=t.rotate(2*l,0,0,0,r);t.context().beginPath(),t.context().moveTo(i.x+c.x,i.y+c.y),t.context().lineTo(i.x+p.x,i.y+p.y),t.context().strokeStyle="#1e582f",t.context().lineWidth=Math.max(1.5,a),t.context().stroke();var u=t.rotate(-l,0,0,0,r),_=t.rotate(-l,h,0,0,r),f=t.rotate(l,h,0,0,r),d=t.rotate(l,0,0,0,r);t.context().beginPath(),t.context().moveTo(i.x+u.x,i.y+u.y),t.context().lineTo(i.x+_.x,i.y+_.y),t.context().lineTo(i.x+f.x,i.y+f.y),t.context().lineTo(i.x+d.x,i.y+d.y),t.context().fillStyle="#2d82ed",t.context().fill()}},O.prototype.renderPosition=function(t,e){var n=t.gtoc(this._target.position()._lat,this._target.position()._lon),i=this._target.isControlled()?this._target.controller().getTargetCode():"*";t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="center",t.context().textBaseline="middle",t.context().strokeStyle="#000",t.context().lineWidth=2,t.context().strokeText(i,n.x,n.y),t.context().fillStyle=this.renderDataBlockColor(e),t.context().fillText(i,n.x,n.y)},O.prototype.renderPartialDataBlock=function(t,e){var n=t.gtoc(this._target.position()._lat,this._target.position()._lon),i=O.getLeaderTipOffset();t.context().beginPath(),t.context().imageSmoothingEnabled=!1,t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="middle",t.context().fillStyle=this.renderDataBlockColor(e);var o=Math.floor(this._target.speed()/10),r=Math.floor(this._target.altitude()/100);t.context().fillText(t.pad(r,3)+"  "+t.pad(o,2),n.x+i.x+5,n.y-10-i.y),t.context().imageSmoothingEnabled=!0},O.prototype.renderFullDataBlock=function(t,e){var n=t.gtoc(this._target.position()._lat,this._target.position()._lon),i=O.getLeaderTipOffset();t.context().beginPath(),t.context().imageSmoothingEnabled=!1,t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="middle",t.context().fillStyle=this.renderDataBlockColor(e);var o=this._target.callsign();this._target.conflictState()===M.CONFLICT_STATES.INHIBITED&&(o+=" "+String.fromCharCode(parseInt("25B3",16))),t.context().fillText(o,n.x+i.x+5,n.y-10-i.y),t.context().imageSmoothingEnabled=!0,t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="middle",t.context().fillStyle=this.renderDataBlockColor(e);var r,a=Math.floor(this._target.speed()/10),s=Math.floor(this._target.altitude()/100),l=this._target.otherController(),h=l?l.getIdentifier():"  ";r=this._target.isCoasting()?"CST"+h+(2e3>e%4e3?t.pad(a,2):this._target.type()):2e3>e%4e3?t.pad(s,3)+h+t.pad(a,2):this._target.arrival()+h+this._target.type(),t.context().fillText(r,n.x+i.x+5,n.y-10-(i.y-17))},O.prototype.renderConflictAlert=function(t){var e=t.gtoc(this._target.position()._lat,this._target.position()._lon),n=O.getLeaderTipOffset();(this._target.conflictState()===M.CONFLICT_STATES.CONFLICTING||this._target.conflictState()===M.CONFLICT_STATES.SUPPRESSED)&&(t.context().beginPath(),t.context().font="bold 14px Oxygen Mono",t.context().textAlign="left",t.context().textBaseline="middle",t.context().fillStyle="#f00",t.context().fillText("CA",e.x+n.x+5,e.y-10-(n.y+17)))},O.prototype.renderDataBlock=function(t,e){var n=t.gtoc(this._target.position()._lat,this._target.position()._lon),i=O.getLeaderTipOffset();t.context().beginPath(),t.context().moveTo(n.x,n.y+-10),t.context().lineTo(n.x+i.x,n.y-10-i.y),t.context().lineWidth=1,t.context().strokeStyle=this.renderDataBlockColor(e),t.context().stroke(),this._target.isExpanded()?this.renderFullDataBlock(t,e):this.renderPartialDataBlock(t,e),this.renderConflictAlert(t)},C.prototype.render=function(t){var e,n=this._path.waypoints();t.context().fillStyle="#0c0",t.context().strokeStyle="#0c0",t.context().lineJoin="round",t.context().textBaseline="center",t.context().textAlign="center",t.context().font="10px Oxygen Mono",e=t.gtoc(n[0].position._lat,n[0].position._lon),t.context().strokeStyle="#030",t.context().lineWidth=4,t.context().beginPath(),t.context().moveTo(e.x,e.y);for(var i=1;i<n.length;i++)e=t.gtoc(n[i].position._lat,n[i].position._lon),t.context().lineTo(e.x,e.y);t.context().stroke(),e=t.gtoc(n[0].position._lat,n[0].position._lon),t.context().strokeStyle="#0c0",t.context().lineWidth=4,t.context().beginPath(),t.context().setLineDash([25,1e3]),t.context().lineDashOffset=-t.elapsed()%1025,t.context().moveTo(e.x,e.y);for(var o=1;o<n.length;o++)e=t.gtoc(n[o].position._lat,n[o].position._lon),t.context().lineTo(e.x,e.y);t.context().stroke(),t.context().setLineDash([]);var r=t.gtoc(n[0].position._lat,n[0].position._lon);if(t.context().beginPath(),t.context().arc(r.x,r.y,4,0,2*Math.PI),t.context().fill(),n.length>1){{var a=t.gtoc(n[n.length-1].position._lat,n[n.length-1].position._lon),s=t.gtoc(n[1].position._lat,n[1].position._lon),l=t.gtoc(n[n.length-2].position._lat,n[n.length-2].position._lon),h=r.y<s.y?1:-1;a.y<l.y?1:-1}t.context().fillText(this._path.name(),r.x,r.y-12*h),t.context().beginPath(),t.context().arc(a.x,a.y,4,0,2*Math.PI),t.context().fill()}else t.context().fillText(this._path.name(),r.x,r.y-12)};var B=B||{};B.COMBO_KEYS={NONE:0,ALT:1,CTRL:2,SHIFT:4,CMD:8},B.combo=function(t){var e=B.COMBO_KEYS.NONE;return t.altKey&&(e|=B.COMBO_KEYS.ALT),t.ctrlKey&&(e|=B.COMBO_KEYS.CTRL),t.shiftKey&&(e|=B.COMBO_KEYS.SHIFT),t.metaKey&&(e|=B.COMBO_KEYS.CMD),e},B.KEYS={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LEFT_WINDOW_KEY:91,RIGHT_WINDOW_KEY:92,SELECT_KEY:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL_POINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUAL_SIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222},B.KEYS.MULTIFUNC=B.KEYS.F7,B.MODES={NONE:1,MULTIFUNC:2},B.MODE=B.MODES.NONE,B[B.KEYS.ESCAPE]={},B[B.KEYS.ESCAPE][B.COMBO_KEYS.NONE]=function(){H.textOverlay().clearPreview()},B[B.KEYS.F3]={},B[B.KEYS.F3][B.COMBO_KEYS.NONE]=function(){H.textOverlay().clearPreview(),H.textOverlay().addPreviewChar("IC")},B[B.KEYS.F4]={},B[B.KEYS.F4][B.COMBO_KEYS.NONE]=function(){H.textOverlay().clearPreview(),H.textOverlay().addPreviewChar("TC")},B[B.KEYS.MULTIFUNC]={},B[B.KEYS.MULTIFUNC][B.COMBO_KEYS.NONE]=function(){H.textOverlay().clearPreview(),H.textOverlay().addPreviewChar("F"),B.MODE=B.MODES.MULTIFUNC},B[B.KEYS.F11]={},B[B.KEYS.F11][B.COMBO_KEYS.NONE]=function(){H.textOverlay().clearPreview(),H.textOverlay().addPreviewChar("CA")},B[B.KEYS.S]={},B[B.KEYS.S][B.COMBO_KEYS.CTRL]=function(){$(".scope-settings").toggle()},B[B.KEYS.M]={},B[B.KEYS.M][B.COMBO_KEYS.CTRL]=function(){$(".situation-controls").toggle(),$(".situation-controls").is(":visible")?($(H.renderer().scope()).css("margin-left","250px"),$(".scope-settings").css("margin-left","250px")):($(H.renderer().scope()).css("margin-left","0"),$(".scope-settings").css("margin-left","0"))},B[B.KEYS.R]={},B[B.KEYS.R][B.COMBO_KEYS.CTRL]=function(){},B[B.KEYS.T]={},B[B.KEYS.T][B.COMBO_KEYS.CTRL]=function(){$(".incoming-messages").toggle()},B[B.KEYS.P]={},B[B.KEYS.P][B.COMBO_KEYS.CTRL]=function(){},B[B.KEYS.ONE]={},B[B.KEYS.ONE][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(1)},B[B.KEYS.ONE][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(1)},B[B.KEYS.TWO]={},B[B.KEYS.TWO][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(2)},B[B.KEYS.TWO][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(2)},B[B.KEYS.THREE]={},B[B.KEYS.THREE][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(3)},B[B.KEYS.THREE][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(3)},B[B.KEYS.FOUR]={},B[B.KEYS.FOUR][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(4)},B[B.KEYS.FOUR][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(4)},B[B.KEYS.FIVE]={},B[B.KEYS.FIVE][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(5)},B[B.KEYS.FIVE][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(5)},B[B.KEYS.SIX]={},B[B.KEYS.SIX][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(6)},B[B.KEYS.SIX][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(6)},B[B.KEYS.SEVEN]={},B[B.KEYS.SEVEN][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(7)},B[B.KEYS.SEVEN][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(7)},B[B.KEYS.EIGHT]={},B[B.KEYS.EIGHT][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(8)},B[B.KEYS.EIGHT][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(8)},B[B.KEYS.NINE]={},B[B.KEYS.NINE][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(9)},B[B.KEYS.NINE][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(9)},B[B.KEYS.ZERO]={},B[B.KEYS.ZERO][B.COMBO_KEYS.CTRL|B.COMBO_KEYS.ALT]=function(){H.renderer().setPreset(0)},B[B.KEYS.ZERO][B.COMBO_KEYS.CTRL]=function(){H.renderer().selectPreset(0)},B[B.KEYS.BACKSPACE]={},B[B.KEYS.BACKSPACE][B.COMBO_KEYS.NONE]=function(){H.textOverlay().removePreviewChar()},B[B.KEYS.ADD]={},B[B.KEYS.ADD][B.COMBO_KEYS.NONE]=function(){H.textOverlay().targetSelect()},B[B.KEYS.TAB]={},B[B.KEYS.TAB][B.COMBO_KEYS.NONE]=function(){H.textOverlay().targetSelect()},B[B.KEYS.ENTER]={},B[B.KEYS.ENTER][B.COMBO_KEYS.NONE]=function(){H.textOverlay().processPreviewArea(null,H._controller)},B[B.KEYS.LEFT_ARROW]={},B[B.KEYS.LEFT_ARROW][B.COMBO_KEYS.NONE]=function(){switch(H.textOverlay().lines()){case 2:H.textOverlay().addPreviewChar("TL"),H.textOverlay().addPreviewChar(" ");break;case 3:H.textOverlay().addPreviewChar("L")}},B[B.KEYS.RIGHT_ARROW]={},B[B.KEYS.RIGHT_ARROW][B.COMBO_KEYS.NONE]=function(){switch(H.textOverlay().lines()){case 2:H.textOverlay().addPreviewChar("TR"),H.textOverlay().addPreviewChar(" ");break;case 3:H.textOverlay().addPreviewChar("R")}},B[B.KEYS.UP_ARROW]={},B[B.KEYS.UP_ARROW][B.COMBO_KEYS.NONE]=function(){switch(H.textOverlay().lines()){case 2:H.textOverlay().addPreviewChar("CM"),H.textOverlay().addPreviewChar(" ");break;case 3:H.textOverlay().addPreviewChar("C")}},B[B.KEYS.DOWN_ARROW]={},B[B.KEYS.DOWN_ARROW][B.COMBO_KEYS.NONE]=function(){switch(H.textOverlay().lines()){case 2:H.textOverlay().addPreviewChar("DM"),H.textOverlay().addPreviewChar(" ");break;case 3:H.textOverlay().addPreviewChar("C")}},B[B.KEYS.DECIMAL_POINT]={},B[B.KEYS.DECIMAL_POINT][B.COMBO_KEYS.NONE]=function(){H.textOverlay().addPreviewChar("SPD"),H.textOverlay().addPreviewChar(" ")},B[B.KEYS.EQUAL_SIGN]={},B[B.KEYS.EQUAL_SIGN][B.COMBO_KEYS.NONE]=function(){H.textOverlay().addPreviewChar("ILS"),H.textOverlay().addPreviewChar(" ")},B[B.KEYS.DASH]={},B[B.KEYS.DASH][B.COMBO_KEYS.NONE]=function(){H.textOverlay().addPreviewChar("VA"),H.textOverlay().addPreviewChar(" ")};var Y=Y||{};Y.ERROR={FORMAT:0,TAKE_NO_ACTION:1},Y.SEGMENT_TYPE={PLACEHOLDER:0,CALLSIGN:0,HEADING:0,ALTITUDE:0,SPEED:0,SECTOR:0,RUNWAY:0,PATH_NAME:0,PATH_FIXES:0},Y.SEGMENT={ILS:"ILS",VISUAL_APPROACH:"VA",INITIATE_CONTROL:"IC",TERMINATE_CONTROL:"TC",FLY_HEADING:"FH",MAINTAIN_ALTITUDE:"MA",SPEED:"SPD",DRAW_PATH:"DRAWPATH",TYPE_PATH:"TYPEPATH",SHOW_PATH:"SHOWPATH",HIDE_PATH:"HIDEPATH",RELOCATE_TARGET:"RELOCATE",MEASURE_DISTANCE:"*",SHOW_COORDINATES:"FD*",TOGGLE_CONFLICT_ALERTS:"CAK",MANAGE_CRDA:"FN",CLEAR_JRING:"*J",CLEAR_ALL_JRINGS:"**J",CLEAR_CONE:"*P",CLEAR_ALL_CONES:"**P"},Y.SEGMENT_RAW={ILS:!0,VA:!0,IC:!0,TC:!0,FH:!0,MA:!0,SPD:!0,TYPE_PATH:!0,FIXPATH:!0,"*":!0,"FD*":!0,CAK:!0,FN:!0,"*J":!0,"**J":!0,"*P":!0,"**P":!0,RELOCATE:"true"},Y.ALIAS={TL:Y.SEGMENT.FLY_HEADING,TR:Y.SEGMENT.FLY_HEADING,CM:Y.SEGMENT.MAINTAIN_ALTITUDE,DM:Y.SEGMENT.MAINTAIN_ALTITUDE,SLOW:Y.SEGMENT.SPEED,DP:Y.SEGMENT.DRAW_PATH,TP:Y.SEGMENT.TYPE_PATH,SP:Y.SEGMENT.SHOW_PATH,HP:Y.SEGMENT.HIDE_PATH,RELOC:Y.SEGMENT.RELOCATE_TARGET,REPO:Y.SEGMENT.RELOCATE_TARGET},Y.currentCommand=[],Y.lastCommand=[],Y.cleanupFunction=null,Y.clickable=function(t){if("click"!==t.type)throw Y.ERROR.FORMAT},Y.enterable=function(t){if("click"===t.type)throw Y.ERROR.FORMAT},Y.registerCleanupFunction=function(t,e){Y.cleanup(e),Y.cleanupFunction=t},Y.cleanup=function(t){Y.clearCleanupTimeout(),Y.cleanupFunction&&(t&&JSON.stringify(Y.currentCommand)===JSON.stringify(Y.lastCommand)||Y.cleanupFunction(),Y.cleanupFunction=null,H.render())},Y.cleanupTimeout=null,Y.clearCleanupTimeout=function(){Y.cleanupTimeout&&(clearTimeout(Y.cleanupTimeout),Y.cleanupTimeout=null)},Y.cleanupIn=function(t){Y.clearCleanupTimeout(),Y.cleanupTimeout=setTimeout(function(){Y.cleanup(),Y.clearCleanupTimeout()},t)},Y.run=function(t,e){var n=Y.manualProcess(t,e),i=[];if(!n){for(var o in e)arg=e[o],Y.SEGMENT_RAW[arg]||(arg=Y.ALIAS[arg]||Y.SEGMENT_TYPE.PLACEHOLDER),i.push(arg);n=Y;for(var r in i)n=n[i[r]]||Y.manualProcess(t,e),n||H.textOverlay().formatError()}Y.currentCommand=i;try{n(t,e),H.textOverlay().clearPreview()}catch(a){switch(a){case Y.ERROR.FORMAT:H.textOverlay().formatError()}}Y.lastCommand=i},Y.manualProcess=function(t,e){var n=e[0],i=/^$/,o=/^\*P(\d{1,2}(\.\d|))$/,r=/^\*J(\d{1,2}(\.\d|))$/,a=/^FN([A-Z]{3,4})(\d{2}[A-Z]{0,1})\/(\d{2}[A-Z]{0,1})$/,s=/^FN(\d)$/;if(2===n.length){var l=H.getControllerByIdentifier(n);if(l)return function(t){if("click"===t.type){var e=H.select(t);if(e)return void(e.isUndergoingHandoff()?(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()})):socket.emit("ATC.requestHandoff",{controller:H.controller().getIdentifier(),to:n,aircraft:e.callsign()},function(t){t?e.handoff(l):(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}))}))}throw Y.ERROR.FORMAT}}switch(!0){case i.test(n):return function(t){if("click"===t.type){var e=H.select(t);e&&e.isUndergoingInboundHandoff()&&socket.emit("ATC.acceptHandoff",{controller:e.otherController().getIdentifier(),to:H.controller().getIdentifier(),aircraft:e.callsign()},function(t){t?e.acceptHandoff():(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}))})}};case o.test(n):return function(t){if("click"===t.type){var e=o.exec(n),i=parseFloat(e[1]);if(1>i||i>30)throw Y.ERROR.FORMAT;var r=H.select(t);r&&r.enableCone(i)}};case r.test(n):return function(t){if("click"===t.type){var e=r.exec(n),i=parseFloat(e[1]);if(1>i||i>30)throw Y.ERROR.FORMAT;var o=H.select(t);o&&o.enableJRing(i)}};case a.test(n):return function(t){Y.enterable(t);var e=a.exec(n),i=3===e[1].length?"K"+e[1]:e[1],o=e[2],r=e[3];throw H.facilityManager().airport(i,function(t){if(t)try{H.CRDAManager().addRemoveCRDA(t,o,r),H.textOverlay().clearPreview()}catch(e){H.textOverlay().setPreviewAreaMessage("ILL RWY"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()})}else H.textOverlay().setPreviewAreaMessage("ILL APT"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()})}),Y.ERROR.TAKE_NO_ACTION};case s.test(n):return function(t){Y.enterable(t);var e=s.exec(n),i=parseInt(e[1],10);H.CRDAManager().toggleCRDA(i)}}return null},Y[Y.SEGMENT_TYPE.PLACEHOLDER]={},Y[Y.SEGMENT.SHOW_COORDINATES]=function(t){if("click"===t.type){var e=H.selectPosition(t);return H.addRenderPoint(e),H.textOverlay().setPreviewAreaMessage(e._lat.toFixed(4)+","+e._lon.toFixed(4)),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage(),H.clearRenderPoints()}),void Y.cleanupIn(15e3)}throw Y.ERROR.FORMAT},Y[Y.SEGMENT.CLEAR_JRING]=function(t){if("click"===t.type){var e=H.select(t);if(e)return void e.disableJRing()}throw Y.ERROR.FORMAT},Y[Y.SEGMENT.CLEAR_ALL_JRINGS]=function(t){Y.enterable(t),H.targetManager().getAllTargets().forEach(function(t){t.disableJRing()})},Y[Y.SEGMENT.CLEAR_CONE]=function(t){if("click"===t.type){var e=H.select(t);if(e)return void e.disableCone()}throw Y.ERROR.FORMAT},Y[Y.SEGMENT.CLEAR_ALL_CONES]=function(t){Y.enterable(t),H.targetManager().getAllTargets().forEach(function(t){t.disableCone()})},Y[Y.SEGMENT.MANAGE_CRDA]=function(t){if("click"===t.type){var e=H.select(t);if(e)return void e.promoteGhosting();if(e=H.CRDAManager().select(t))return void e.demoteGhosting();throw Y.ERROR.FORMAT}H.CRDAManager().toggle()},Y[Y.SEGMENT.RELOCATE_TARGET]=function(){var t=null;return function(e){if("click"===e.type){var n=H.select(e);if(n)throw t=n,Y.ERROR.TAKE_NO_ACTION;if(t){var i=H.selectPosition(e);return console.log("emitting:"),console.log("TS.relocate"),console.log({callsign:t.callsign(),lat:i._lat,lon:i._lon}),void socket.emit("TS.relocate",{callsign:t.callsign(),lat:i._lat,lon:i._lon})}}throw Y.ERROR.FORMAT}}(),Y[Y.SEGMENT.MEASURE_DISTANCE]=function(t){if("click"===t.type){var e=H.measureHeadingAndDistance(t);throw e&&(H.addRenderPoint(H.selectPosition(t)),H.textOverlay().clearPreview(),H.textOverlay().setPreviewAreaMessage(e.heading+"/"+e.distance),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage(),H.clearRenderPoints()}),Y.cleanupIn(15e3)),Y.ERROR.TAKE_NO_ACTION}throw Y.ERROR.FORMAT},Y[Y.SEGMENT.INITIATE_CONTROL]=function(t){if("click"===t.type){var e=H.select(t);if(e)return void(e.isUndergoingHandoff()?(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()})):socket.emit("ATC.initiateControl",{aircraft:e.callsign(),controller:H.controller().getIdentifier()},function(t){t||(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}))}))}throw Y.ERROR.FORMAT},Y[Y.SEGMENT.TERMINATE_CONTROL]=function(t){if("click"===t.type){var e=H.select(t);if(e)return void(e.isUndergoingHandoff()?(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()})):e.isUndergoingInboundHandoff()?socket.emit("ATC.refuseHandoff",{controller:e.otherController().getIdentifier(),to:H.controller().getIdentifier(),aircraft:e.callsign()},function(t){t?e.refuseHandoff():(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}))}):socket.emit("ATC.terminateControl",{aircraft:e.callsign(),controller:H.controller().getIdentifier()},function(t){t||(H.textOverlay().setPreviewAreaMessage("ILL TRK"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}))}))}throw Y.ERROR.FORMAT},Y[Y.SEGMENT.TOGGLE_CONFLICT_ALERTS]=function(t){if("click"===t.type){var e=H.select(t);if(e)return e.toggleConflictAlerts()}throw Y.ERROR.FORMAT},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.ILS]={},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.ILS][Y.SEGMENT_TYPE.RUNWAY]=function(t,e){var n=!1;if(H.facilityManager().primaryAirport(function(t){if(t){var i=e[0],o=e[2],r=H.targetManager().getTargetByCallsign(i),a=t.runway(o);if(r&&a)return socket.emit("TS.ILS",{callsign:i,icao:t.icao(),runway:o}),void H.textOverlay().clearPreview()}H.textOverlay().formatError(),n=!0}),n)throw Y.ERROR.FORMAT},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.VISUAL_APPROACH]={},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.VISUAL_APPROACH][Y.SEGMENT_TYPE.RUNWAY]=function(t,e){var n=!1;if(H.facilityManager().primaryAirport(function(t){if(t){var i=e[0],o=e[2],r=H.targetManager().getTargetByCallsign(i),a=t.runway(o);if(r&&a)return socket.emit("TS.visualApproach",{callsign:i,icao:t.icao(),runway:o}),void H.textOverlay().clearPreview()}H.textOverlay().formatError(),n=!0}),n)throw Y.ERROR.FORMAT},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.FLY_HEADING]={},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.FLY_HEADING][Y.SEGMENT_TYPE.HEADING]=function(t,e){var n=e[0],i=e[2],o=H.targetManager().getTargetByCallsign(n);if(o&&o.assignHeading(i))throw H.textOverlay().keepFirstLine(),Y.ERROR.TAKE_NO_ACTION;throw Y.ERROR.FORMAT},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.MAINTAIN_ALTITUDE]={},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.MAINTAIN_ALTITUDE][Y.SEGMENT_TYPE.SPEED]=function(t,e){var n=e[0],i=e[2],o=H.targetManager().getTargetByCallsign(n);
if(o&&o.assignAltitude(i))throw H.textOverlay().keepFirstLine(),Y.ERROR.TAKE_NO_ACTION;throw Y.ERROR.FORMAT},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.SPEED]={},Y[Y.SEGMENT_TYPE.CALLSIGN][Y.SEGMENT.SPEED][Y.SEGMENT_TYPE.SPEED]=function(t,e){var n=e[0],i=e[2],o=H.targetManager().getTargetByCallsign(n);if(o&&o.assignSpeed(i))throw H.textOverlay().keepFirstLine(),Y.ERROR.TAKE_NO_ACTION;throw Y.ERROR.FORMAT},Y[Y.SEGMENT.SHOW_PATH]={},Y[Y.SEGMENT.SHOW_PATH][Y.SEGMENT_TYPE.PATH_NAME]=function(t,e){try{H.pathManager().showPath(e[1].toUpperCase())}catch(n){switch(n){case y.ERROR.PATH_NOT_FOUND:throw H.textOverlay().setPreviewAreaMessage("ILL PTH"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}),Y.ERROR.TAKE_NO_ACTION}}},Y[Y.SEGMENT.HIDE_PATH]={},Y[Y.SEGMENT.HIDE_PATH][Y.SEGMENT_TYPE.PATH_NAME]=function(t,e){try{H.pathManager().hidePath(e[1].toUpperCase())}catch(n){switch(n){case y.ERROR.PATH_NOT_FOUND:throw H.textOverlay().setPreviewAreaMessage("ILL PTH"),Y.registerCleanupFunction(function(){H.textOverlay().clearPreviewAreaMessage()}),Y.ERROR.TAKE_NO_ACTION}}},Y[Y.SEGMENT.DRAW_PATH]={},Y[Y.SEGMENT.DRAW_PATH][Y.SEGMENT_TYPE.PATH_NAME]=function(){var t=null,e=function(){t=null,H.textOverlay().clearPreviewAreaMessage()};return function(n,i){H.textOverlay().clearPreviewAreaMessage();var o=i[1].toUpperCase();if(!o)throw Y.ERROR.FORMAT;if(t||(t=new T(o)),"click"===n.type){Y.registerCleanupFunction(e,!0);var r=H.selectPosition(n),a=t.waypoints(),s=a[a.length-1],l=a[a.length-2];if(s){if(.539957*s.position.distanceTo(r)<1)throw H.textOverlay().setPreviewAreaMessage("ILL DIST"),Y.ERROR.TAKE_NO_ACTION;if(l){var h=l.position.bearingTo(s.position),c=s.position.bearingTo(r);if(H.renderer().angleBetweenHeadings(h,c)>=90)throw H.textOverlay().setPreviewAreaMessage("ILL TURN"),Y.ERROR.TAKE_NO_ACTION}}throw t.addWaypoint(null,r),H.pathManager().setPath(t),H.pathManager().showPath(o),Y.ERROR.TAKE_NO_ACTION}e()}}(),Y[Y.SEGMENT.TYPE_PATH]={},Y[Y.SEGMENT.TYPE_PATH][Y.SEGMENT_TYPE.PATH_NAME]={},Y[Y.SEGMENT.TYPE_PATH][Y.SEGMENT_TYPE.PATH_NAME][Y.SEGMENT_TYPE.PATH_FIXES]=function(t,e){H.textOverlay().clearPreviewAreaMessage();var n=e[1].toUpperCase(),i=e[2].split("."),o=i.length;if(n&&o){H.textOverlay().setPreviewAreaMessage("LOAD...");var r=0,a={},s=new T(n),l=function(){Y.registerCleanupFunction(function(){H.clearRenderPaths(),H.textOverlay().clearPreviewAreaMessage()},!0);for(var t in i){var e=i[t],o=a[e];if(!o)return void H.textOverlay().setPreviewAreaMessage("ILL RTE");s.addWaypoint(e,o)}H.pathManager().setPath(s),H.pathManager().showPath(n),H.textOverlay().clearPreviewAreaMessage()},h=function(t,e){r++,e.navaid&&(a[t]=e.navaid),r===o&&l()},c=function(t,e){r++,e.fix&&(a[t]=e.fix),r===o&&l()};for(var p in i){i[p]=i[p].toUpperCase();var u=i[p];3===u.length?$.get("/api/navaids/"+u,h.bind(this,u)):5===u.length?$.get("/api/fixes/"+u,c.bind(this,u)):(r++,r===o&&l())}throw Y.ERROR.TAKE_NO_ACTION}throw Y.ERROR.FORMAT},m.prototype.bindServerListeners=function(){this._socket.on("textMessage",function(t){var e=$("<p>").text(t.from.toUpperCase()+"> "+t.message);$(".incoming-messages").append(e)}),this._socket.on("controllers",function(t){this._scope.setControllers(t.map(function(t){return c.fromJSON(t)}))}.bind(this)),this._socket.on("ownershipClaimed",function(t){var e=H.targetManager().getTargetByCallsign(t.aircraft);if(e){var n=H.getControllerByIdentifier(t.controller);e.setController(n)}}),this._socket.on("handoffRequested",function(t){var e=H.targetManager().getTargetByCallsign(t.aircraft);if(e){var n=H.getControllerByIdentifier(t.controller);e.inboundHandoff(n)}}),this._socket.on("handoffAccepted",function(t){var e=H.targetManager().getTargetByCallsign(t.aircraft);if(e){var n=H.getControllerByIdentifier(t.to);e.handoffAccepted(n)}}),this._socket.on("handoffRefused",function(t){var e=H.targetManager().getTargetByCallsign(t.aircraft);e&&e.handoffRefused()})};{var H=new v(socket);new m(H,socket)}$(document).ready(function(){R(),P(),I(),N(),L(),w(),b(),$(".control-section h1").click(function(){var t=$(this).parent();t.hasClass("expanded")?t.removeClass("expanded"):($(".control-section").removeClass("expanded"),t.addClass("expanded"))}),$(".control-section .button").click(function(){var t=$(this).text().trim();("On"===t||"Off"===t)&&$(this).text("On"===t?"Off":"On")}),$(".control-section").keydown(function(t){t.stopPropagation()}),$(".control-section").keypress(function(t){t.stopPropagation()}),$(".control-section input").mouseout(function(){$(this).blur()})})}();